![å¦‚ä½•ä½¿ç”¨åå°è„šæœ¬è·å–Chromeæ‰©å±•ç¨‹åºä¸­çš„æ•°æ®](https://levelup.gitconnected.com/how-to-use-background-script-to-fetch-data-in-chrome-extension-ef9d7f69625d)
å¦‚ä½•ä½¿ç”¨åå°è„šæœ¬è·å–Chromeæ‰©å±•ç¨‹åºä¸­çš„æ•°æ®
========================

[![èƒ¡æ™¨](https://miro.medium.com/fit/c/96/96/0*wqXxW38QpnxDbRP_.jpeg)](/@chen?source=post_page-----ef9d7f69625d----------------------)

[èƒ¡æ™¨](/@chen?source=post_page-----ef9d7f69625d----------------------)

è·Ÿéš

[7æœˆ8æ—¥](/how-to-use-background-script-to-fetch-data-in-chrome-extension-ef9d7f69625d?source=post_page-----ef9d7f69625d----------------------) Â· 6 åˆ†é’Ÿé˜…è¯»

![](https://miro.medium.com/max/60/1*E3_Npitn4Hi9qedCf5aA5w.jpeg?q=20)

![](https://miro.medium.com/max/1280/1*E3_Npitn4Hi9qedCf5aA5w.jpeg)

![](https://miro.medium.com/max/2560/1*E3_Npitn4Hi9qedCf5aA5w.jpeg)

é»‘å®¢æ ‡ç­¾ï¼šChromeæ‰©å±•ç¨‹åºï¼Œç”¨äºåœ¨æ–°æ ‡ç­¾ä¸ŠæŸ¥çœ‹GitHubè¶‹åŠ¿é¡¹ç›®ğŸ“ˆ

å¦‚æœæ‚¨ä¸ç¡®å®šå¦‚ä½•ç¼–å†™chromeæ‰©å±•ï¼Œæ‚¨å¯ä»¥å…ˆæŸ¥çœ‹æˆ‘ä¹‹å‰çš„æ•…äº‹[**å¦‚ä½•ä½¿ç”¨React.jsåœ¨5åˆ†é’Ÿå†…åˆ›å»ºè·¨æµè§ˆå™¨æ‰©å±•**](/how-to-use-react-js-to-create-chrome-extension-in-5-minutes-2ddb11899815)ã€‚å®ƒæ•™æ‚¨å¦‚ä½•ä½¿ç”¨create-react-appä¸ºæ–°é€‰é¡¹å¡æ„å»ºæµè§ˆå™¨æ‰©å±•ã€‚

æˆ‘ä»¬æ„å»ºçš„æ‰©å±•ç¨‹åºå¾ˆå¥½ï¼Œä½†æ¯æ¬¡ç”¨æˆ·æ‰“å¼€ä¸€ä¸ªæ–°é€‰é¡¹å¡æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šä»APIé‡æ–°åŠ è½½æœ€æ–°çš„è¶‹åŠ¿å­˜å‚¨åº“ï¼Œè¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿã€‚å³ä½¿å®ƒåªéœ€è¦ä¸€ç§’é’Ÿï¼Œæ–°çš„æ ‡ç­¾æ‰“å¼€ä»ç„¶å¾ˆæ…¢ã€‚

> å¦‚æœæˆ‘ä»¬å®šæœŸåœ¨åå°è·å–æ•°æ®ï¼Œå°†æ•°æ®ä¿å­˜åœ¨localStorageä¸­ï¼Œå¹¶åœ¨æ‰“å¼€æ–°Tabæ—¶è¯»å–å®ƒä¼šæ€ä¹ˆæ ·ï¼Ÿ

æˆ‘èŠ±äº†å‡ å¤©æ—¶é—´å¯¹å®ƒè¿›è¡Œç ”ç©¶ï¼Œå‘ç°å®ƒå®Œå…¨å¯è¡Œã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†ä¸æ‚¨åˆ†äº«æˆ‘åœ¨æ­¤è¿‡ç¨‹ä¸­å­¦åˆ°çš„çŸ¥è¯†ã€‚

1.å‘manifest.jsonæ·»åŠ åå°è„šæœ¬
======================

åå°è„šæœ¬å¯ä»¥å¯¹æµè§ˆå™¨äº‹ä»¶åšå‡ºååº”å¹¶æ‰§è¡ŒæŸäº›æ“ä½œï¼Œåå°é¡µé¢åœ¨éœ€è¦æ—¶åŠ è½½ï¼Œåœ¨ç©ºé—²æ—¶å¸è½½ã€‚è¦ä½¿ç”¨åå°æ–‡ä»¶ï¼Œè¯·åœ¨æ–‡ä»¶ä¸­å£°æ˜å¦‚ä¸‹`manifest.json`ï¼š

![](https://miro.medium.com/max/60/1*MFhgQocI8gTPcWm3BG1IUw.png?q=20)

![](https://miro.medium.com/max/668/1*MFhgQocI8gTPcWm3BG1IUw.png)

![](https://miro.medium.com/max/1336/1*MFhgQocI8gTPcWm3BG1IUw.png)

æ‚¨å°†æ³¨æ„åˆ°`persistent`å‚æ•°ï¼Œåœ¨æ‰©å±•çš„ç”Ÿå‘½å‘¨æœŸä¸­å­˜åœ¨æŒä¹…æ€§åå°é¡µé¢ï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ªå®ä¾‹åœ¨Chromeæµè§ˆå™¨çš„åå°ä¸»åŠ¨è¿è¡Œï¼Œç­‰å¾…ç”¨æˆ·ä¸æ‰©å±•è¿›è¡Œäº¤äº’ã€‚

æ ¹æ®[Googleå¼€å‘äººå‘˜æ–‡æ¡£](https://developer.chrome.com/extensions/background_migration)ï¼Œå»ºè®®ä½¿ç”¨éæŒä¹…æ¨¡å¼ï¼Œè¿™æœ‰åŠ©äºé™ä½æ‰©å±•çš„èµ„æºæˆæœ¬ã€‚éæŒä¹…æ€§åå°è„šæœ¬çº¯ç²¹åŸºäºäº‹ä»¶ï¼Œå®ƒä¼šä¸€ç›´å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°ä»–ä»¬æ­£åœ¨ä¾¦å¬ç«ç¾ï¼Œå¯¹æŒ‡å®šæŒ‡ä»¤åšå‡ºååº”ç„¶åå¸è½½ã€‚ä¸€äº›äº‹ä»¶çš„ä¾‹å­åŒ…æ‹¬ï¼š

*   é¦–å…ˆå®‰è£…æˆ–æ›´æ–°æ‰©å±•ç¨‹åºä»¥é‡æ–°å¯åŠ¨æ–°ç‰ˆæœ¬æˆ–æµè§ˆå™¨ã€‚
*   åå°é¡µé¢æ­£åœ¨ä¾¦å¬äº‹ä»¶ï¼Œå¹¶è°ƒåº¦è¯¥äº‹ä»¶ã€‚ï¼ˆä¾‹å¦‚ï¼Œæˆ‘ä»¬å°†`[alarm](https://developers.chrome.com/extensions/alarms)`å®šæœŸåˆ›å»ºæ´¾é£æ´»åŠ¨ï¼‰
*   å†…å®¹è„šæœ¬æˆ–å…¶ä»–æ‰©å±•ç¨‹åº[å‘é€æ¶ˆæ¯ã€‚](https://developer.chrome.com/extensions/messaging)
*   æ‰©å±•ä¸­çš„å¦ä¸€ä¸ªè§†å›¾ï¼Œä¾‹å¦‚å¼¹å‡ºçª—å£ï¼Œè°ƒç”¨`[runtime.getBackgroundPage](https://developer.chrome.com/extensions/runtime#method-getBackgroundPage)`ã€‚

2.æ·»åŠ è­¦æŠ¥ä»¥å®šæœŸè§¦å‘æ“ä½œ
=============

æ‚¨å¯èƒ½ç†Ÿæ‚‰ä»¥ä¸‹ä»£ç ä»¥å®šæœŸè¿è¡ŒæŸäº›å†…å®¹ï¼š

window.setIntervalï¼ˆfunctionï¼ˆï¼‰{   
 console.logï¼ˆ'Helloï¼Œworldï¼'ï¼‰;   
}ï¼Œ1000 \* 60 \* 3ï¼‰;

å®ƒæ¯3åˆ†é’Ÿæ‰“å°ä¸€æ¬¡â€œHelloï¼Œworldï¼â€ã€‚è¦å°†å…¶æ›´æ”¹ä¸ºåŸºäºäº‹ä»¶çš„è­¦æŠ¥ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨[è­¦æŠ¥API](https://developer.chrome.com/extensions/alarms)ã€‚

chrome.alarms.createï¼ˆ'refresh'ï¼Œ{periodInMinutesï¼š3}ï¼‰;

ç„¶åæ·»åŠ ä¸€ä¸ªç›‘å¬å™¨ã€‚

chrome.alarms.onAlarm.addListenerï¼ˆï¼ˆalarmï¼‰=> {   
 alertï¼ˆâ€œHelloï¼Œworldï¼â€ï¼‰;   
}ï¼‰;

å®‰è£…æ‰©å±•æ—¶æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªè­¦æŠ¥ï¼Œä»¥ä¾¿åœ¨åå°æ¯3åˆ†é’Ÿè§¦å‘ä¸€æ¬¡è­¦æŠ¥ï¼Œè¿™æ˜¯æˆ‘ä»¬`background.js`åˆ°ç›®å‰ä¸ºæ­¢ã€‚

è¦ä½¿ç”¨è­¦æŠ¥ï¼Œæ‚¨è¿˜éœ€è¦æ·»åŠ `alarms`æƒé™`manifest.json`

3.è°ƒè¯•åå°è„šæœ¬
========

è¦æµ‹è¯•ä¸Šè¿°è„šæœ¬æ˜¯å¦å¯ä»¥æŒ‰é¢„æœŸè¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦åœ¨æœ¬åœ°æµ‹è¯•å®ƒã€‚è¿™ä¸[ä¹‹å‰æ•…äº‹ä¸­](/how-to-use-react-js-to-create-chrome-extension-in-5-minutes-2ddb11899815)çš„æ­¥éª¤éå¸¸ç›¸ä¼¼ã€‚

1.  ç¡®ä¿å¼€å‘äººå‘˜æ¨¡å¼å·²æ‰“å¼€ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚
2.  å•å‡»â€œåŠ è½½è§£å‹ç¼©â€ï¼Œç›®æ ‡æ–‡ä»¶å¤¹åŒ…å«æ‚¨çš„`manifest.json`ã€‚
3.  æ‚¨åº”è¯¥å•å‡»`background page`ï¼Œè€Œä¸æ˜¯åœ¨æ–°é€‰é¡¹å¡ä¸Šè¿›è¡Œæ£€æŸ¥ï¼Œå› ä¸ºåå°é¡µé¢åœ¨å•ç‹¬çš„è¿›ç¨‹ä¸­è¿è¡Œã€‚
4.  å¦‚æœæ‚¨åœ¨æœ¬åœ°æ›´æ”¹äº†ä»£ç ï¼Œåˆ™éœ€è¦å•å‡»â€œé‡æ–°åŠ è½½â€ã€‚

![](https://miro.medium.com/max/60/1*ZZGyikrW8ch4wb5RpJrzWg.jpeg?q=20)

![](https://miro.medium.com/max/1449/1*ZZGyikrW8ch4wb5RpJrzWg.jpeg)

![](https://miro.medium.com/max/2898/1*ZZGyikrW8ch4wb5RpJrzWg.jpeg)

åœ¨æœ¬åœ°æµ‹è¯•æ‰©å±•

ä»ä¸‹å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œè­¦æŠ¥æ¯3åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ã€‚

![](https://miro.medium.com/max/60/1*bWmCzyGWk-6Hgo96hhGPyw.png?q=20)

![](https://miro.medium.com/max/752/1*bWmCzyGWk-6Hgo96hhGPyw.png)

![](https://miro.medium.com/max/1504/1*bWmCzyGWk-6Hgo96hhGPyw.png)

æ£€æŸ¥åå°è„šæœ¬

ä½ ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œæ£€æŸ¥**ç½‘ç»œ**ï¼Œ**localStorage**ã€‚å¦‚æœæ‚¨çš„æ‰©å±•ç¨‹åºä¿®æ”¹äº†æ–°æ ‡ç­¾ï¼Œåˆ™ä¼šåœ¨æ‚¨çš„æ‰©å±•ç¨‹åºä¸­å…±äº«localStorageï¼Œå³æˆ‘ä»¬åœ¨åå°è„šæœ¬å’Œæ–°æ ‡ç­¾æ‰©å±•ç¨‹åºä¹‹é—´ä¼ é€’æ•°æ®çš„æ–¹å¼ã€‚

4.è·å–æ•°æ®å¹¶ä¿å­˜åˆ°localStorage
======================

ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªåŸºæœ¬çš„æŠ¥è­¦å·¥ä½œï¼Œè®©æˆ‘ä»¬è·å–æ•°æ®å¹¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ã€‚ç¨ååœ¨æˆ‘ä»¬çš„Reactæ‰©å±•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä»åŠ è½½çš„æœ¬åœ°å­˜å‚¨è¯»å–è€Œä¸æ˜¯ä»APIè·å–ã€‚

1.  é¦–æ¬¡å®‰è£…æˆ–å‡çº§æ‰©å±•æ—¶ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªâ€œ **åˆ·æ–°** â€è­¦æŠ¥ï¼Œæ¯30åˆ†é’Ÿè·å–å¹¶ä¿å­˜ä¸€æ¬¡æ•°æ®ã€‚
2.  æˆ‘ä»¬å°†åœ¨é‡æ–°å¯åŠ¨chromeæ—¶è·å–æ•°æ®ï¼Œä»¥ä¾¿ç”¨æˆ·è·å–æœ€æ–°æ•°æ®ã€‚
3.  æˆ‘ä»¬è¿˜å°†æ¯5åˆ†é’Ÿåˆ›å»ºä¸€ä¸ªâ€œ **çœ‹é—¨ç‹—** â€è­¦æŠ¥ï¼Œä»¥æ£€æŸ¥åˆ·æ–°è­¦æŠ¥æ˜¯å¦ä»ç„¶å¯ç”¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œæˆ‘ä»¬å°†åˆ›å»ºå®ƒã€‚ï¼ˆè¿™é‡Œå¯èƒ½æ²¡æœ‰å¿…è¦ï¼‰

5.é‡ç”¨é€»è¾‘å¹¶è½¬æ¢åˆ°ES5
=============

ä¸Šé¢çš„ä»£ç æœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦è§£å†³å®ƒä»¬ï¼š

1.  è¯·æ³¨æ„ï¼Œæˆ‘ä»¬æ²¡æœ‰ç¼–å†™å®ç°ï¼Œ`fetchRepositories`å¹¶ä¸”`saveToLocalStorage`å®ƒä»¬å¾ˆå¯èƒ½å·²ç»åœ¨æ‚¨çš„Reactåº”ç”¨ç¨‹åºä¸­å¯ç”¨ï¼Œå¯ä»¥å°†å®ç°å¤åˆ¶åˆ°`background.js`ä½†æ˜¯å¦‚æœæˆ‘ä»¬å¯ä»¥é‡ç”¨è¿™äº›å‡½æ•°æ¥ä¿æŒä»£ç DRYä¼šæ›´å¥½ã€‚
2.  æˆ‘ä»¬å·²ç»ç¼–å†™äº†`background.js`ä½¿ç”¨ES6è¯­æ³•ï¼Œ`**=>**`å¹¶ä¸”`**async await**`æ—§ç‰ˆæµè§ˆå™¨å¯èƒ½æ— æ³•è¿è¡Œå®ƒã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`webpack`å¸®åŠ©æ†ç»‘å’Œè½¬æ¢ä»£ç åˆ°ES5ã€‚

5.1å®‰è£…ä¾èµ–é¡¹
--------

çº±çº¿æ·»åŠ --dev webpack-cli npm-run-all rimraf

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ä¸åº”è¯¥å®‰è£…`webpack.`ï¼ˆ`react-scripts`å·²ç»ä¾èµ–å®ƒï¼Œå®ƒä¼šæŠ±æ€¨å¦ä¸€ä¸ªå®ä¾‹`webpack`ï¼‰ã€‚å¦‚æœæ‚¨ä¸ä½¿ç”¨ï¼Œè¯·éšæ„å®‰è£…`create-react-app`ã€‚

5.2æ›´æ”¹æ„å»ºè„šæœ¬
---------

ç°åœ¨æ›´æ”¹`build`è„šæœ¬ä»¥æ„å»ºåº”ç”¨ç¨‹åºå’Œåå°è„šæœ¬ï¼š

â€œprebuildâ€ï¼šâ€œrimraf buildâ€ï¼Œ  
â€œbuildâ€ï¼šâ€œnpm-run-all buildï¼š\*â€ï¼Œ  
â€œbuildï¼šappâ€ï¼šâ€œINLINE\_RUNTIME\_CHUNK = false react-scripts buildâ€ï¼Œ  
â€œbuildï¼šbgâ€ï¼šâ€œwebpack  -æ¨¡å¼åˆ¶ä½œ./src/background.js --output ./build/background.jsâ€œï¼Œ

æˆ‘ä»¬å·²ç»`INLINE_RUNTIME_CHUNK=false`åœ¨[ä¹‹å‰çš„æ•™ç¨‹ä¸­](/how-to-use-react-js-to-create-chrome-extension-in-5-minutes-2ddb11899815)ä»‹ç»è¿‡äº†ã€‚æ›´æ”¹åï¼Œå¦‚æœæ‚¨è¿è¡Œ`npm run build`ï¼Œå®ƒå°†æ‰§è¡Œ

*   æ¸…ç†`build`æ–‡ä»¶å¤¹
*   ä½¿ç”¨åŒ…æ†ç»‘Reactæ‰©å±• `react-script`
*   æ†ç»‘`src/background.js`ä½¿ç”¨webpackå¹¶å¯¼å‡ºåˆ°`build/background.js`

5.3é‡æ„./src/background.js
------------------------

åœ¨æ‚¨çš„å·¥ä½œä¸­`src/background.js`ï¼Œæ‚¨å¯ä»¥è‡ªç”±åœ°å¯¼å…¥ä»»ä½•å¤–éƒ¨åº“ï¼Œ`lodash`æˆ–è€…ä»å…¶ä»–æ–‡ä»¶å¯¼å…¥å¸¸é‡/å‡½æ•°ï¼Œä¾‹å¦‚ï¼š

ä»'./lib/helpers' å¯¼å…¥{   
 fetchRepositoriesï¼Œ  
 saveToLocalStorage   
}; chrome.runtime.onInstalled.addListenerï¼ˆï¼ˆï¼‰=> {   
...

ä½ çš„ä»£ç ç°åœ¨æ›´å¹²å‡€äº†ã€‚

5.4æ›´æ–°ESlinté…ç½®
-------------

å¦‚æœæ‚¨åœ¨ç¼–è¾‘å™¨ä¸­ä½¿ç”¨ESLintï¼Œå¯èƒ½ä¼šæŠ±æ€¨æ‚¨çš„å†…å®¹`chrome`æœªå®šä¹‰`./src/background.js`ã€‚è¿™æ˜¯å› ä¸º`chrome`APIä»…åœ¨æ‰©å±•ä¸­å¯ç”¨ï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰ESLintæˆ‘ä»¬æ­£åœ¨å¼€å‘æ‰©å±•ï¼Œè¯·å¿½ç•¥å®ƒä»¬ã€‚

æ·»åŠ /æ›´æ–°æ‚¨çš„ä»¥ä¸‹è¡Œ`package.json`ã€‚

â€œeslintConfigâ€ï¼š{   
 â€œextendsâ€ï¼šâ€œreact-appâ€ï¼Œ  
 â€œenvâ€ï¼š{   
 â€œbrowserâ€ï¼štrueï¼Œ  
 â€œwebextensionsâ€ï¼štrue   
 }   
}

æ·»åŠ `webextensions`å`env`ï¼Œç¼–è¾‘å°†ä¸å†æŠ±æ€¨å®ƒã€‚

5.5æ·»åŠ .babelrc
-------------

Webpackéœ€è¦ä¸€ä¸ª`.babelrc`æ–‡ä»¶æ¥ç¼–è¯‘ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ·»åŠ å®ƒã€‚æ—¢ç„¶`react-scripts`å·²ç»å®‰è£…`babel-presets-react-app`ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨å®ƒã€‚

{   
 â€œé¢„è®¾â€ï¼š\[â€œreact-appâ€\]   
}

ç°åœ¨è¿è¡Œ`npm run build`å°†ä¸æ‚¨çš„`build`æ–‡ä»¶å¤¹ä¸­çš„å·²ç¼–è¯‘åå°è„šæœ¬ä¸€èµ·å®Œæˆæ‰©å±•ã€‚

è€Œå·²ï¼
===

å¦‚æœæ‚¨å¾ˆå¥½å¥‡ï¼Œå¯ä»¥åœ¨GitHubä¸Šæ£€æŸ¥æˆ‘çš„æ‰©å±•[æäº¤](https://github.com/huchenme/hacker-tab-extension/commit/ff765829f2d96ea5e53265b11d4a27cec4133b5d)ä¸­æ›´æ”¹çš„æ‰€æœ‰æ–‡ä»¶ã€‚

* * *

æ„Ÿè°¢æ‚¨é˜…è¯»æ­¤å†…å®¹ã€‚æ‚¨å¯ä»¥åœ¨[Githubä¸­](https://github.com/huchenme/hacker-tab-extension)æŸ¥çœ‹æºä»£ç æˆ–åœ¨[Chrome Web Store](https://chrome.google.com/webstore/detail/hacker-tab/ibomigipadcieapbemkegkmadbbanbgm)å’Œ[Firefox Add-ons Hubä¸­](https://addons.mozilla.org/en-US/firefox/addon/hacker-tab/)ä¸‹è½½æ‰©å±•[ç¨‹åº](https://addons.mozilla.org/en-US/firefox/addon/hacker-tab/)ï¼Œå¿«ä¹çš„é»‘å®¢æ”»å‡»ï¼Œå¹¶è®©æˆ‘çŸ¥é“æ‚¨æ„å»ºçš„å†…å®¹ï¼