![Rustä¸­çš„WebAssemblyæ¨¡å—](https://medium.com/@rossbulat/webassembly-modules-an-introduction-5554b8982402)
Rustä¸­çš„WebAssemblyæ¨¡å—ï¼šç®€ä»‹
======================

å¦‚ä½•ç”Ÿæˆå’Œæ„å»ºWasmæ¨¡å—ï¼Œå¹¶å°†å…¶å¯¼å…¥Reacté¡¹ç›®
--------------------------

[![ç½—æ–¯å¸ƒæ‹‰ç‰¹](https://miro.medium.com/fit/c/48/48/1*49Z_ce0CnC1mH7xtlmAkSg.jpeg)](/@rossbulat?source=post_page-----5554b8982402----------------------)

[ç½—æ–¯å¸ƒæ‹‰ç‰¹](/@rossbulat?source=post_page-----5554b8982402----------------------)

è·Ÿéš

[9æœˆ2æ—¥](/@rossbulat/webassembly-modules-an-introduction-5554b8982402?source=post_page-----5554b8982402----------------------) Â· 13 åˆ†é’Ÿé˜…è¯»

![](https://miro.medium.com/max/30/1*9hFW7f_3s3gEcPoG05f4KA.jpeg?q=20)

![](https://miro.medium.com/max/1200/1*9hFW7f_3s3gEcPoG05f4KA.jpeg)

WebAssemblyï¼Œç½‘ç»œçš„æœªæ¥ï¼Ÿ
------------------

[WebAssembly](https://developer.mozilla.org/en-US/docs/WebAssembly)è¢«ç§°ä¸ºWeb _çš„_æœªæ¥æŠ€æœ¯ï¼Œèƒ½å¤Ÿä»¥æ¥è¿‘æœ¬æœºçš„é€Ÿåº¦åœ¨æµè§ˆå™¨ä¸­è¿è¡Œä»£ç ã€‚WebAssemblyï¼ˆé€šå¸¸ç¼©å†™ä¸ºwasmï¼‰æ˜¯ä¸€ç§ç´§å‡‘çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œå®ƒä½¿ç”¨Cå’ŒC ++ç­‰è¯­è¨€ç¼–è¯‘ï¼Œä»¥åŠRust - æˆ‘ä»¬å°†åœ¨æœ¬æ–‡ä¸­æ¼”ç¤ºçš„è¯­è¨€ã€‚

Rustæ˜¯ä¸€ç§ç›¸å¯¹è¾ƒæ–°çš„è¯­è¨€ï¼Œå®ƒå·²ç»ä¸ºWebAssemblyä¸­çš„æ¨¡å—å¼€å‘ï¼Œç¼–è¯‘å’Œå‘å¸ƒæä¾›äº†å¤§é‡æ”¯æŒï¼Œä¸»è¦ç”±Mozilla Foundationé¢†å¯¼ã€‚Rustå’ŒWebAssemblyçš„å¼€å‘æ­£åœ¨è¿›è¡Œä¸­ï¼Œå°½ç®¡Rustå¤„äºæ›´æˆç†Ÿçš„çŠ¶æ€ã€‚å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é¢„æœŸæœ¬æ–‡ä¸­è®¨è®ºçš„APIä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œå‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬ä¼šåœ¨å‘å¸ƒç‰ˆæœ¬æ—¶å°è¯•åŠæ—¶æ›´æ–°ã€‚

[_AssemblyScript_](https://github.com/AssemblyScript/assemblyscript)_æ˜¯Typescriptçš„ä¸€ä¸ªä¸¥æ ¼å­é›†ï¼Œæ˜¯å¦ä¸€ç§æœ‰è¶£çš„è¯­è¨€ï¼Œæ—¨åœ¨è®©Javascriptå¼€å‘äººå‘˜å¼€å§‹é‡‡ç”¨Wasmï¼Œå‰ç«¯å¼€å‘äººå‘˜çš„å­¦ä¹ æ›²çº¿æ¯”Rustæˆ–C ++æ›´å°ã€‚è¿™æ˜¯WebAssemblyç”Ÿæ€ç³»ç»Ÿä¸­åˆ›æ–°çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚_

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†å‘å¸ƒä¸€ä¸ªå‘Githubå‘å‡ºè·å–è¯·æ±‚çš„wasmæ¨¡å—ï¼Œå¹¶è¿”å›ç”Ÿæˆçš„JSONã€‚ç„¶åå°†åœ¨Create React Appé¡¹ç›®ä¸­ä»Javascriptè°ƒç”¨æ­¤ç¼–è¯‘çš„wasmå‡½æ•°ã€‚

å¯ä»¥[åœ¨Github](https://github.com/rossbulat/wasm-fetch-example)ä¸Šæ‰¾åˆ°ä¸æ­¤ä½œå“ç›¸ç¬¦çš„å®Œæ•´é¡¹ç›®ã€‚

Rust WebAssemblyå·¥å…·
------------------

è¦ä½¿ç”¨Rustæ„å»ºä¸€ä¸ªwasmæ¨¡å—ï¼Œæˆ‘ä»¬å°†åˆ©ç”¨ä¸¤ä¸ªæ¡†æ¶æ¥æ‰“åŒ…æ¨¡å—å¹¶ä½¿ç¼–è¯‘çš„WebAssemblyä¸æµè§ˆå™¨è¿›è¡Œäº¤äº’ï¼š

*   `[**wasm-pack**](https://rustwasm.github.io/docs/wasm-pack/)`ï¼ˆ[Github](https://github.com/rustwasm/wasm-pack)ï¼‰ï¼šç”¨äºä¸ºç½‘ç»œç¼–è¯‘åŸºäºRustçš„WebAssemblyçš„â€œä¸€ç«™å¼æœåŠ¡â€ã€‚`wasm-pack`æ˜¯ä¸€ä¸ªCLIå·¥å…·ï¼Œå¯ä»¥æ„å»ºï¼Œæµ‹è¯•å’Œå‘å¸ƒWebAssemblyæ¨¡å—
*   `[**wasm-bindgen**](https://rustwasm.github.io/docs/wasm-bindgen/)`  ï¼ˆ[Github](https://github.com/rustwasm/wasm-bindgen)ï¼‰**ï¼š** Ruståº“å’ŒCLIå·¥å…·ï¼Œç”¨äºä¿ƒè¿›ä¸Javascriptå’ŒDOMçš„äº¤äº’ã€‚äº‹å®ä¸Šï¼Œ`wasm-bindgen`ä¸ºæ‰€æœ‰Web APIæä¾›ç»‘å®šçš„åº•å±‚APIï¼Œå¯ä»¥æ“ä½œDOMï¼Œç›‘å¬äº‹ä»¶ï¼Œè°ƒç”¨è·å–è¯·æ±‚ï¼Œwebsocketsç­‰ç­‰ - æ‰€æœ‰è¿™äº›éƒ½æ˜¯ç”¨Rustç¼–è¯‘çš„

é‡è¦çš„æ˜¯è¦å¼ºè°ƒWebAssemblyä¸èƒ½ç›´æ¥è®¿é—®DOMã€‚æ¯«æ— ç–‘é—®ï¼Œè¿™å°†åœ¨1 - 2å¹´å†…æœ‰æ‰€ä¸åŒï¼Œç°åœ¨å¼€å‘çš„[å„ç§ææ¡ˆ](https://github.com/WebAssembly/proposals)å°†è§£å†³[å¤šçº¿ç¨‹](https://github.com/webassembly/threads/blob/master/proposals/threads/Overview.md)å’Œç›´æ¥DOMæ“ä½œç­‰åŠŸèƒ½ï¼Œè¿™æ˜¯ç›®å‰å­˜åœ¨çš„WebAssemblyé‡‡ç”¨çš„ä¸¤ä¸ªä¸»è¦ç“¶é¢ˆã€‚

ç›®å‰ï¼Œ`wasm-bindgen`å®ƒå……å½“äº†ä¸Javascript APIäº¤äº’çš„æ¡¥æ¢ï¼Œæ‰€æœ‰è¿™äº›APIéƒ½åœ¨åº“ä¸­å…·æœ‰Rustç»‘å®šã€‚è¿™æ˜¯é€šè¿‡ä¸¤ä¸ªåº•å±‚ä¾èµ–é¡¹æ¥å®Œæˆçš„`wasm-bindgen`ï¼š`[js-sys](https://docs.rs/js-sys/0.3.27/js_sys/)`crateå’Œ`[web-sys](https://docs.rs/web-sys/0.3.27/web_sys/)`crateï¼Œåˆ†åˆ«å°†æ•´ä¸ªJavascriptæ ‡å‡†åº“å’ŒWeb APIåº“æš´éœ²ç»™Rustå’ŒWebAssemblyã€‚

æ€»ç»“ä¸€ä¸‹è¿™ä¸ªä»‹ç»ï¼Œæˆ‘ä»¬åœ¨çŸ­æœŸå†…æœ€æœ‰å¯èƒ½æœŸå¾…çš„æ˜¯ï¼š

*   `wasm-bindgen`éšç€æ›´å¤šWebAssemblyææ¡ˆçš„å®æ–½å’Œæ”¯æŒåœ¨æµè§ˆå™¨ä¸­æ¨å‡ºï¼Œå¤§å¤§åŠ å¿«ã€‚æˆ‘ä»¬è¿˜å¯ä»¥æœŸæœ›æ›´å°çš„æ¨¡å—å°ºå¯¸ï¼Œå› ä¸ºæ ·æ¿ä»£ç å˜å¾—ä¸å¿…è¦äº†
*   `wasm-bindgen`å°†åœ¨åŠŸèƒ½æ¨å‡ºæ—¶å°è¯•ç»´æŠ¤å…¶é¡¶çº§APIï¼Œä½†`web-sys`éšç€ç›´æ¥DOMæ“ä½œçš„æ¨å‡ºï¼Œåº•å±‚æ— ç–‘ä¼šå‘ç”Ÿé‡å¤§å˜åŒ–
*   `js-sys`ä»ç„¶ä¼šå‡ºç°ä¸Javascriptæ ‡å‡†åº“å’ŒJavascriptæ¨¡å—è¿›è¡Œäº¤äº’çš„ç›®çš„ï¼Œ**è¿™ä¸¤ç§è¯­è¨€å°†æºæ‰‹åˆä½œ**

æœ€åä¸€ç‚¹å¾ˆå¯èƒ½æ˜¯çŸ­æœŸå†…WebAssemblyçš„ä¸»è¦ç”¨ä¾‹ã€‚åœ¨Javascriptä¸­å·²ç»å»ºç«‹äº†æ¨¡å—åº“ï¼ˆä»¥åŠæ•´ä¸ªWebåº”ç”¨ç¨‹åºï¼‰ï¼Œæ²¡æœ‰ä»€ä¹ˆåŠ¨åŠ›å°†æ•´ä¸ªé¡¹ç›®é‡æ–°æ„å»ºåˆ°WebAssemblyä¸­ã€‚

ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥æœŸå¾…çš„æ˜¯åŸºäºWebAssemblyçš„æ¨¡å—ï¼Œå®ƒå¯ä»¥å¾ˆå¥½åœ°å®Œæˆç‰¹å®šçš„äº‹æƒ…ï¼ŒåŒ…å«åœ¨NPMæ¨¡å—ä¸­å¹¶å¯¼å…¥åˆ°Javascripté¡¹ç›®ä¸­ã€‚æ¨¡å—å¦‚ï¼š

*   **è®¡ç®—æˆæœ¬é«˜æ˜‚çš„** **ä¸œè¥¿ï¼Œ**å¦‚å¤„ç†æ•°å­—ï¼Œæ¸²æŸ“3Då¯¹è±¡æˆ–è¿è¡Œæœºå™¨å­¦ä¹ ç®—æ³•ã€‚åœ¨wasmä¸­çš„è¿™äº›ä»»åŠ¡å°†æ¯”å®ƒä»¬çš„Javascriptå¯¹åº”ç¨‹åºå¿«ä¸€ä¸ªæ•°é‡çº§
*   **åŒºå—é“¾è½»å®¢æˆ·ç«¯å’Œåˆ†å¸ƒå¼ç½‘ç»œåè®®**ã€‚ä½¿ç”¨åŒºå—é“¾å®¢æˆ·ç«¯ï¼Œç‰¹åˆ«æ˜¯Parityçš„ä»¥å¤ªç½‘å’ŒSubstrateæ¡†æ¶ï¼Œå¾ˆæ˜æ˜¾å°†å…¶ç°æœ‰æºä»£ç ç¼–è¯‘åˆ°WebAssemblyä¸­å°†å…·æœ‰å……åˆ†æ„ä¹‰ï¼Œè®©å®¢æˆ·ç«¯å®¢æˆ·ç«¯ä½œä¸ºå¯¼å…¥æ¨¡å—åœ¨æµè§ˆå™¨ä¸­è¿è¡Œã€‚è¿™äº›è¿˜å°†åˆ©ç”¨é€Ÿåº¦å’Œæ•ˆç‡ï¼ŒåŒæ—¶ä»æ‚¨çš„UXä»£ç æ¨¡å—åŒ–åè®®çº§API
*   å€ŸåŠ©Rustå†…ç½®çš„å†…å­˜å®‰å…¨æ€§å’Œä¸¥æ ¼çš„æ‰“å­—åŠŸèƒ½ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°†å®‰å…¨åŠŸèƒ½å’Œå®æ—¶èŠå¤©/å®æ—¶Webç¯å¢ƒç­‰**å…³é”®ä»»åŠ¡å·¥å…·**å®ç°ä¸ºWebAssemblyæ¨¡å—ï¼Œå¹¶æ³¨é‡ç¨³å®šæ€§

Javascriptä¸ä¼šå»ä»»ä½•åœ°æ–¹
-----------------

è¿™äº›åœ¨Javascriptæ–¹é¢æ„å‘³ç€ä»€ä¹ˆï¼Ÿåœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œå¾ˆéš¾çœ‹åˆ°æ²¡æœ‰Javascriptæˆä¸ºç½‘ç»œä¸»å¯¼è¯­è¨€çš„æœªæ¥ã€‚Javascriptä¸ä¼šéšå¤„å¯è§ï¼Œè€ŒWebAssemblyå¾ˆå¯èƒ½æ˜¯å¯¹Javascriptçš„è¡¥å……ï¼Œè€Œä¸æ˜¯æ›¿ä»£ï¼ŒåŠ é€Ÿäº†åº”ç”¨ç¨‹åºçš„æŸäº›éƒ¨åˆ†ï¼Œå¹¶æä¾›äº†æ›´å¤šæ–¹æ³•æ¥ä½¿å…¶ä»–è¯­è¨€çš„ä»£ç åº“åœ¨æµè§ˆå™¨ä¸­è¿è¡Œã€‚

æœ‰äº†è¿™ä¸ªç†è§£ï¼Œè®©æˆ‘ä»¬ç°åœ¨è·³è¿›ä¸€ä¸ªçœŸå®ä¸–ç•Œçš„ä¾‹å­ã€‚æˆ‘ä»¬å°†ç¨å¾®ä¿®æ”¹Githubä¸Šæ‰˜ç®¡çš„[ç¤ºä¾‹ä¸­](https://github.com/rustwasm/wasm-bindgen/tree/master/examples)çš„[è·å–è¯·æ±‚ç¤ºä¾‹](https://github.com/rustwasm/wasm-bindgen/tree/master/examples/fetch)ã€‚`wasm-bindgen`[](https://github.com/rustwasm/wasm-bindgen/tree/master/examples)

ç„¶åï¼Œæˆ‘ä»¬å°†å¼‚æ­¥å¯¼å…¥æ­¤æ¨¡å—åˆ°Create React Appé¡¹ç›®ä¸­ï¼Œå¹¶åœ¨Reactç»„ä»¶ä¸­è°ƒç”¨æˆ‘ä»¬çš„wasmå‡½æ•°ï¼Œä¸ºwebpackæä¾›äº†åœ¨è¿‡ç¨‹ä¸­è¯†åˆ«åŸºäºwasmçš„æ¨¡å—è€Œæ— éœ€å¼¹å‡ºé¡¹ç›®çš„æ–¹æ³•ã€‚

* * *

å®‰è£…Wasm Pack
===========

ä¸ºäº†ä¾¿äºè®¨è®ºï¼Œæˆ‘ä»¬å°†å…‹éš†ä¸æ­¤éƒ¨åˆ†é‡åˆçš„[gitå­˜å‚¨åº“](https://github.com/rossbulat/wasm-fetch-example)ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ª`wasm-pack`ç”Ÿæˆçš„Rusté¡¹ç›®ï¼Œå…¶ä¸­åŒ…å«è·å–è¯·æ±‚ä»£ç ã€‚æˆ‘ä»¬è¿˜å°†ä»‹ç»ä¸€äº›åŸºæœ¬çš„è®¾ç½®æ­¥éª¤ã€‚

å…³äºVSä»£ç çš„è¯´æ˜
---------

Visual Studioä»£ç å¯¹[RLS](https://marketplace.visualstudio.com/items?itemName=rust-lang.rust)æ‰©å±•çš„Rustæä¾›äº†å¾ˆå¥½çš„æ”¯æŒã€‚æ­¤å¤–ï¼Œ[WebAssembly](https://marketplace.visualstudio.com/items?itemName=dtsvet.vscode-wasm)æ‰©å±•è¿˜å¯ç”¨äºå¼ºåˆ¶è¯­æ³•çªå‡ºæ˜¾ç¤ºå’Œè½»æ¾é¢„è§ˆwasmäºŒè¿›åˆ¶æ–‡ä»¶çš„åŠŸèƒ½ã€‚

_ä»¥ä¸‹è¯´æ˜å‡å®šæ‚¨å·²åœ¨ç³»ç»Ÿä¸Šå®‰è£…äº†Rustã€‚å¦‚æœæ²¡æœ‰ï¼Œè¯·è½¬åˆ°_[_Rust Installationé¡µé¢_](https://www.rust-lang.org/tools/install)_å¹¶ä¸‹è½½_`_rustup_`_ã€‚_

è®©æˆ‘ä»¬é¦–å…ˆä¸ºæˆ‘ä»¬çš„esmåŠªåŠ›å®‰è£…æ‰€éœ€çš„CLIå·¥å…·ï¼Œä»å¼€å§‹`wasm-pack`ã€‚æœ€æ–°çš„å®‰è£…è¯´æ˜å°†åœ¨å…¶[å®‰è£…é¡µé¢ä¸Š](https://rustwasm.github.io/wasm-pack/installer/)ï¼Œä½†å®‰è£…è½¯ä»¶åŒ…åªéœ€è¦ä¸€ä¸ªcurlè¯·æ±‚ï¼š

**#install wasm-pack  
** curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | SH

ä¸€ä¸ª`wasm-pack`äºŒè¿›åˆ¶æ–‡ä»¶å°†å®‰è£…åœ¨æ‚¨çš„`~/.cargo/bin`ç›®å½•ä¸­ã€‚è¯¥ç¨‹åºåŒ…å«`new`ï¼Œ`build`ï¼Œ`test`å’Œ`publish`å‘½ä»¤çš„æ–‡ä»¶ï¼Œå…¶ä¸­å¯ä»¥å‘ç°[åœ¨è¿™é‡Œ](https://rustwasm.github.io/docs/wasm-pack/commands/index.html)ã€‚

ç†Ÿæ‚‰wasm-bindgen
--------------

è¿˜å»ºè®®å…‹éš†æ•´ä¸ª`wasm-bindgen`å­˜å‚¨åº“ï¼Œå¹¶åœ¨ç³»ç»Ÿä¸Šæ˜¾ç¤ºæ‰€æœ‰ç¤ºä¾‹ä»£ç ä»¥è¿›è¡Œæµ‹è¯•ï¼š

**#clim wasm-bindgen**  
 git clone [https://github.com/rustwasm/wasm-bindgen](https://github.com/rustwasm/wasm-bindgen)

è¯¥`[examples/](https://github.com/rustwasm/wasm-bindgen/tree/master/examples)`æ–‡ä»¶å¤¹åŒ…å«ä¸€ç³»åˆ—é¡¹ç›®ï¼Œè™½ç„¶æœªé…ç½®ä¸ºæ„å»ºä¸ºæ¨¡å—ã€‚æ¯ä¸ªç¤ºä¾‹éƒ½å¯ä»¥åœ¨çº¿æŸ¥çœ‹ï¼Œå¹¶é™„æœ‰ä¸“é—¨çš„æ–‡æ¡£é¡µé¢ã€‚è¯·å‚é˜…æ¯ä¸ªç¤ºä¾‹çš„`README.md`æ–‡ä»¶ä»¥è·å–å®æ—¶æ¼”ç¤ºå’Œæ–‡æ¡£çš„é“¾æ¥ã€‚

æœ€ç®€å•çš„`wasm-bindgen`ä¾‹å­æ˜¯`[console_log](https://github.com/rustwasm/wasm-bindgen/tree/master/examples/console_log)`é¡¹ç›®ï¼Œå±•ç¤ºäº†å¦‚ä½•å°†`console.log()`Javascriptå‡½æ•°ç»‘å®šåˆ°Rustå‡½æ•° - æœ€ç®€å•çš„å®ç°å¦‚ä¸‹ï¼š

**ï¼ƒ\[wasm\_bindgen\]**  
 externâ€œCâ€{ **ï¼ƒ\[wasm\_bindgenï¼ˆjs\_namespace = consoleï¼‰\]** fn logï¼ˆsï¼šï¼†strï¼‰; }  

æˆ‘ä»¬å¿…é¡»æ³¨é‡Šæ‰€æœ‰çš„wasmå—å’Œå‡½æ•°ï¼Œ`#[wasm_bindgen]`è®©ç¼–è¯‘å™¨çŸ¥é“è¿™ä¸ªä»£ç å—å°†è¢«ç¼–è¯‘æˆWebAssemblyã€‚è¿™æ˜¯ä¸€ç§[æ¡ä»¶ç¼–è¯‘](https://doc.rust-lang.org/reference/conditional-compilation.html)ï¼Œ`wasm_bindgen`ç§°ä¸ºå±æ€§ã€‚

**_æ³¨æ„ï¼š_**_æ‚¨å¯èƒ½ä¼šçœ‹åˆ°ä¸€äº›WebAssemblyç¤ºä¾‹åŒ…å«åœ¨å†…_`_extern {}_`_ï¼Œè€Œå…¶ä»–__ç¤ºä¾‹__åˆ™åŒ…å«åœ¨å…¶ä¸­_`_extern â€œCâ€ {}_`_ã€‚ç›®å‰ä¸¤è€…ä¹‹é—´æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚ä¸€ä½æœ‰å…³å¼€å‘äººå‘˜__ä¸ºè¿™ç§å·®å¼‚_[_æ‰“å¼€äº†ä¸€ä¸ªé—®é¢˜_](https://github.com/rustwasm/wasm-bindgen/issues/422)_ï¼Œè¿™ä¼¼ä¹æºäºå…¶è‡ªåŠ¨æ ¼å¼åŒ–åŠŸèƒ½_`rustfmt`_ã€‚_

è®¿é—®æ¡ä»¶ç¼–è¯‘
------

Rustå†…ç½®äº†ä¸€ç³»åˆ—æ¡ä»¶ç¼–è¯‘å±æ€§ï¼Œä¾‹å¦‚`[#cfg](https://doc.rust-lang.org/reference/conditional-compilation.html#the-cfg-attribute)`ç”¨äºç¡®å®šæ˜¯å¦åº”è¯¥åŸºäºå˜é‡ç¼–è¯‘ä»£ç å—çš„å±æ€§ï¼Œä¸€äº›æ˜¯å†…ç½®çš„ï¼Œä¾‹å¦‚ç¨‹åºæ­£åœ¨ç¼–è¯‘çš„å¹³å°ã€‚ä»¥ä¸‹æ˜¯ä»æ–‡æ¡£ä¸­è·å–çš„å‡ ä¸ªç¤ºä¾‹ï¼š

**//æ­¤å‡½æ•°ä»…åœ¨ç¼–è¯‘macOSæ—¶ç¼–è¯‘**  
ï¼ƒ\[cfgï¼ˆtarget\_os =â€œmacosâ€ï¼‰\]   
fn macos\_onlyï¼ˆï¼‰{   
 // ...   
} **//åªæœ‰åœ¨å®šä¹‰äº†fooæˆ–baræ—¶ç¼–è¯‘æ­¤å‡½æ•°**ï¼ƒ\[cfg ï¼ˆä»»ä½•ï¼ˆfooï¼Œbarï¼‰ï¼‰\]   
fn needs\_foo\_or\_barï¼ˆï¼‰{   
 // ...   
}

åœ¨ç¬¬ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œ`[target_os](https://doc.rust-lang.org/reference/conditional-compilation.html#target_os)`æ˜¯ä¸€äº›[è®¾ç½®é…ç½®é€‰é¡¹ä¹‹ä¸€](https://doc.rust-lang.org/reference/conditional-compilation.html#set-configuration-options)ï¼Œå®ƒç¡®å®šæˆ‘ä»¬æ­£åœ¨ç¼–è¯‘çš„å¹³å°ã€‚æˆ‘ä»¬ç”šè‡³å¯ä»¥å®šä¹‰å¹³å°ç‰¹å®šçš„ä¾èµ–å…³ç³»`Cargo.toml`; å¦‚æœæˆ‘åªæƒ³åœ¨è¯¥å¹³å°ä¸Šæ”¯æŒmacOSæ ¸å¿ƒåº“ï¼Œæˆ‘å¯ä»¥åœ¨ä»¥ä¸‹æ–¹é¢æ‰§è¡Œä»¥ä¸‹æ“ä½œ`Cargo.toml`ï¼š

**#Cargo.toml** **\[target.'cfgï¼ˆtarget\_os =â€œmacosâ€ï¼‰'ã€‚dependencies\]**  
 cocoa =â€œ0.18.4â€   
core-foundation =â€œ0.6â€   
core-graphics =â€œ0.17.3â€   
......

æ‚¨å¯èƒ½ä¹Ÿæ³¨æ„åˆ°`#[test]`Rusté¡¹ç›®ä¸­çš„å±æ€§ - é˜»æ­¢ç¼–è¯‘æ³¨é‡Šçš„ä»£ç `#[test]`ï¼Œå¹¶ä¸ä¹‹ä¸€èµ·è¿è¡Œ`cargo test`ã€‚

æ‰€ä»¥ï¼Œ`#[wasm]`å¹¶ä¸”`#[wasm-bindgen]`æ˜¯ä¸“é—¨ç”¨äºç¼–è¯‘åˆ°WebAssemblyçš„è‡ªå®šä¹‰æ³¨é‡Šã€‚é‡æ–°è®¿é—®è¯¥`console.log`ç¤ºä¾‹ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨å±æ€§å‚æ•°æ¥æŒ‡å®šJavascriptåç§°ç©ºé—´ä»¥å°†æˆ‘ä»¬çš„å‡½æ•°ç»‘å®šåˆ°ï¼š

**ï¼ƒ\[wasm\_bindgenï¼ˆjs\_namespace = consoleï¼‰\]**  
 fn logï¼ˆsï¼šï¼†strï¼‰;   
...

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°†`log()`å‡½æ•°ç»‘å®šåˆ°`console.log()`Javascriptå‡½æ•°ã€‚

å…³äºæ¡ä»¶ç¼–è¯‘çš„ä¸»é¢˜ï¼ŒWebAssemblyé¡¹ç›®é€šå¸¸ä¹Ÿä½¿ç”¨`feature` `cfg`å‚æ•°ï¼Œè¿›ä¸€æ­¥è¿‡æ»¤åŸºäºæˆ‘ä»¬å®šä¹‰çš„ç‰¹å¾ç¼–è¯‘çš„å†…å®¹`Cargo.toml`ï¼š

\[åŠŸèƒ½\]   
é»˜è®¤= \[â€œsuper\_modeâ€\]

è¿™äº›åŠŸèƒ½å¯ä»¥åœ¨ä»¥ä¸‹å†…å®¹ä¸­ä½¿ç”¨`#[cfg]`ï¼š

ï¼ƒ\[cfgï¼ˆfeature =â€œsuper\_modeâ€ï¼‰\]   
fn super\_executeï¼ˆsï¼šï¼†str;ï¼‰{   
 ...   
}

ä½¿ç”¨å±æ€§å¯ä»¥å¾ˆæœ‰è¶£ï¼Œä¸ºä»£ç å¢åŠ çµæ´»æ€§ï¼ŒåŒæ—¶é€‚åº”æ‚¨å¯èƒ½é‡åˆ°çš„è¾¹ç¼˜æƒ…å†µ - ä¾‹å¦‚é’ˆå¯¹ç‰¹å®šå®¢æˆ·çš„è‡ªå®šä¹‰æ„å»ºã€‚åŒæ–¹`wasm-pack`å¹¶`wasm-bindgen`åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºå®šåˆ¶æ±‡ç¼–æˆWASMçš„åŠŸèƒ½ã€‚åœ¨[æ­¤å¤„](https://doc.rust-lang.org/reference/attributes.html#attributes)é˜…è¯»æœ‰å…³Rustä¸­å±æ€§çš„æ›´å¤šä¿¡æ¯ã€‚

å›åˆ°`console.log`æ¼”ç¤ºï¼Œè¯¥æ¼”ç¤ºè¿˜è®°å½•äº†`console.log()`å¤šæ€çš„æ–¹å¼ï¼Œå¹¶ä¸”å¯ä»¥æ¥å—å¤šä¸ªå‚æ•°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç»‘å®šå¤šä¸ªç­¾åï¼ŒåŒæ—¶ç¡®ä¿`console.log()`ä»ç„¶ä½¿ç”¨`js_name`å±æ€§å‚æ•°è°ƒç”¨è¯¥å‡½æ•°ï¼š

**ï¼ƒä¸€ä¸ªå¸¦æœ‰æ— ç¬¦å·æ•´æ•°çš„æ—¥å¿—å‡½æ•°**ï¼ƒ\[wasm\_bindgenï¼ˆjs\_namespace = consoleï¼Œ**js\_name = log**ï¼‰\]   
fn log\_u32ï¼ˆaï¼šu32ï¼‰;

è¿™æ˜¯Rustå¦‚ä½•ç»‘å®šåˆ°Javascriptçš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œä¸æˆ‘ä»¬å°è¯•ä½¿ç”¨æˆ‘ä»¬çš„fetchç¤ºä¾‹ç›¸åï¼Œæ—¨åœ¨ä»Javascriptç«¯è°ƒç”¨Rustç¼–è¯‘çš„wasmã€‚

é™¤äº†ä»å­˜å‚¨åº“è¿è¡Œè¿™äº›ç¤ºä¾‹ä¹‹å¤–ï¼Œæœ€å¥½å°†åŠŸèƒ½ä»å®ƒä»¬å¤åˆ¶åˆ°æ‚¨è‡ªå·±çš„`wasm-pack`é¡¹ç›®ä¸­ï¼Œè®°ä½è¦åŒ…å«æ‰€éœ€çš„ä¾èµ–é¡¹`Cargo.toml`ä»¥ä¸å‡½æ•°ä¸€è‡´ã€‚

éšç€ä¸€äº›Rustç†è§£çš„å·©å›ºï¼Œè®©æˆ‘ä»¬ç°åœ¨è½¬åˆ°æˆ‘ä»¬çš„wasm fetchæ¼”ç¤ºã€‚

* * *

Wasmè·å–é¡¹ç›®ç»“æ„
==========

å…‹éš†ä»¥ä¸‹å­˜å‚¨åº“ä»¥è·å–æˆ‘ä»¬æ¥ä¸‹æ¥å°†è¦ä»‹ç»çš„ç¤ºä¾‹æ¼”ç¤ºï¼Œå…¶ä¸­åŒ…å«Rustæ¨¡å—å’ŒReactåº”ç”¨ç¨‹åºå®¢æˆ·ç«¯ï¼š

git clone https://github.com/rossbulat/wasm-fetch-example

è¯¥`wasm-module`ç›®å½•åŒ…å«Rusté¡¹ç›®ï¼Œè€Œè¯¥`client`ç›®å½•åŒ…å«Reactå®¢æˆ·ç«¯ã€‚

_ä¸ºæ–¹ä¾¿èµ·è§ï¼Œæˆ‘å·²å°†ä¸¤ä¸ªé¡¹ç›®æ‰“åŒ…åˆ°ä¸€ä¸ªå­˜å‚¨åº“ä¸­ã€‚å»ºè®®ä»–ä»¬åœ¨é¡¶å±‚ï¼ˆåˆ†æˆç‹¬ç«‹çš„ä»“åº“ï¼Œå¹¶æœ‰æ¯ä¸ªé¡¹ç›®çš„é…ç½®æ–‡ä»¶_`_Cargo.toml_`_ï¼Œ_`_package.json_`_ç­‰ç­‰ï¼‰ã€‚_

å†…éƒ¨çš„æ¨¡å—
-----

`wasm-pack new`å·²è¿è¡Œä»¥ç”Ÿæˆé¡¹ç›®ç»“æ„ï¼Œå¹¶ä¸”å·²å°†[fetch](https://github.com/rustwasm/wasm-bindgen/tree/master/examples/fetch)åŠŸèƒ½æ’å…¥åˆ°æˆ‘ä»¬çš„`lib.rs`ã€‚

åœ¨è°ƒç”¨`call_fetch()`å‡½æ•°ï¼ˆæˆ‘ä»¬å°†åœ¨Javascriptä¸­æ‰§è¡Œï¼‰æ—¶ï¼Œå°†å‘Github `wasm-bindgen`å­˜å‚¨åº“è°ƒç”¨è·å–è¯·æ±‚ï¼Œä»repoè·å–æœ€æ–°çš„æäº¤ã€‚è¿”å›ç”Ÿæˆçš„JSONï¼Œç„¶åå¯ä»¥åœ¨Javascriptç«¯è§£æ„ã€‚

æ–‡ä»¶å¤¹ç»“æ„å¾ˆç®€å•ï¼Œæˆ‘ä»¬çš„Rustæºæ–‡ä»¶åœ¨`src/`ç›®å½•ä¸­ï¼Œå¹¶`Cargo.toml`æ¦‚è¿°äº†é¡¹ç›®ä¾èµ–é¡¹ï¼ˆä»¥Cargo [crates](https://crates.io/)çš„å½¢å¼ï¼‰ï¼Œä»¥åŠä¸€äº›åˆå§‹é…ç½®ï¼š

 #Rust **é¡¹ç›®ç»“æ„** src /   
fetch.rs   
 lib.rs   
 utils.rs .gitignore   
Cargo.toml   
...

è¿™äº›æ˜¯æˆ‘ä»¬æ„Ÿå…´è¶£çš„æ–‡ä»¶ã€‚è®©æˆ‘ä»¬æ·±å…¥äº†è§£è¿™ä¸ªé¡¹ç›®åŒ…å«çš„å†…å®¹ï¼š

*   è¯¥`src/`æ–‡ä»¶å¤¹åŒ…å«è¦ç¼–è¯‘çš„Rustä»£ç ã€‚è¯¥é¡¹ç›®çš„å†…å®¹æ˜¯`[lib.rs](https://github.com/rossbulat/wasm-fetch-example/blob/master/wasm-module/src/lib.rs)`ï¼Œ`call_fetch()`æˆ‘ä»¬å¸Œæœ›åœ¨Javascriptä¸­è°ƒç”¨å‡½æ•°ã€‚æ­¤æ–‡ä»¶åŒ…å«ä¸€ç³»åˆ—useè¯­å¥ï¼Œå¯å°†å„ç§åº“çº³å…¥èŒƒå›´ï¼ŒåŒ…æ‹¬æ‰€éœ€çš„`wasm_bindgen`Javascriptç»‘å®šå’Œç±»å‹
*   `[src/fetch.rs](https://github.com/rossbulat/wasm-fetch-example/blob/master/wasm-module/src/fetch.rs)`åªåŒ…å«ä¸€äº›å°†ç”¨äºå­˜å‚¨è¿”å›çš„è·å–æ•°æ®çš„ç»“æ„ã€‚åœ¨[åŸå§‹çš„](https://github.com/rustwasm/wasm-bindgen/blob/master/examples/fetch/src/lib.rs) `wasm-bindgen` fetchç¤ºä¾‹ä¸­ï¼Œè¿™äº›ç»“æ„ä¹Ÿåœ¨lib.rsä¸­å®šä¹‰ï¼Œä»¥åŠç¤ºä¾‹ä»£ç çš„å…¶ä½™éƒ¨åˆ†ã€‚ä¸ºäº†ä¾¿äºé˜…è¯»ï¼Œæˆ‘é€‰æ‹©å°†å®ƒä»¬ä¸ä¸»æ‰§è¡Œåˆ†å¼€
*   `[Cargo.toml](https://github.com/rossbulat/wasm-fetch-example/blob/master/wasm-module/Cargo.toml)`æ˜¯ä¸€ä¸ªè¦ç†è§£çš„å…³é”®æ–‡ä»¶ï¼Œå®šä¹‰é¡¹ç›®ä¸­ä½¿ç”¨çš„ä¾èµ–é¡¹å’Œâ€œåŠŸèƒ½â€ã€‚æˆ‘ä»¬å°†è®¿é—®è¿™äº›å·¥ä½œå¦‚ä½•è¿›ä¸€æ­¥å‘å±•

åœ¨å°†è¿”å›çš„Promiseè½¬æ¢ä¸ºRust Futureä¹‹å‰ï¼Œå†…éƒ¨çš„æ‰§è¡Œæµç¨‹`call_fetch()`è°ƒç”¨æ¥è‡ª`wasm-bindgen`ç»‘å®šçš„Javascriptè·å–è¯·æ±‚\- Rustæ‰¿è¯ºçš„Rustç­‰ä»·ç‰©ã€‚ä¸€æ—¦ä»Githubæ”¶åˆ°å“åº”ï¼Œå®ƒå°±ä¼šé€šè¿‡å®šä¹‰çš„ç»“æ„è¿›è¡ŒæŒä¹…åŒ–å’Œæ ¼å¼åŒ–`fetch.rs`ã€‚

è¿™æ˜¯å®Œæ•´çš„æ‰§è¡Œæµç¨‹ï¼š

#fetch **è¯·æ±‚æ‰§è¡Œæµç¨‹** - > JSè°ƒç”¨call\_fetchï¼ˆï¼‰\- >é€šè¿‡wasm-bindgenç»‘å®šè°ƒç”¨è·å–è¯·æ±‚ï¼Œè¿”å›promise \- > JS Promiseè½¬æ¢ä¸ºRust Future \- > Await Githubå“åº”å¹¶é€šè¿‡æä¾›çš„ç»“æ„å­˜å‚¨\- > Rust Futureè½¬æ¢å›åˆ°JS Promise \- >è¿”å›åœ¨JSä¸­ä½¿ç”¨çš„å“åº”

æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ¢è®¨çš„é‚£æ ·ï¼Œéšç€WebAssemblyè§„èŒƒå˜å¾—æ›´å¼ºå¤§ï¼Œè¿™ä¸ªè¿‡ç¨‹å°†å˜å¾—æ›´åŠ ç®€åŒ–ã€‚

ä½¿ç”¨wasm-packæ„å»ºæ„å»ºæ¨¡å—
-----------------

è¿è¡Œæ—¶`wasm-pack build`ï¼Œç¼–è¯‘ç»“æœå°†è¾“å‡ºåˆ°`pkg/`é¡¹ç›®æ–‡ä»¶å¤¹ä¸­çš„ç›®å½•ã€‚äº‹å®ä¸Šæˆ‘ä»¬ç°åœ¨å¯ä»¥è¿™æ ·åšæ¥æ£€æŸ¥ç»“æœï¼š

#build **project** cd wasm-fetch-example wasm-pack build \> \[INFO\]ï¼šğŸ¯æ£€æŸ¥Wasmç›®æ ‡...   
\> \[INFO\]ï¼šğŸŒ€ç¼–è¯‘ä¸ºWasm ...   
\>ç¼–è¯‘proc-macro2 v0.4.30   
 ...

é¡¹ç›®æ„å»ºæ—¶é—´å–å†³äºæ‚¨çš„ç³»ç»Ÿã€‚ç”Ÿæˆçš„`pkg/`æ–‡ä»¶å¤¹å°†åŒ…å«æˆ‘ä»¬ç¼–è¯‘çš„æ¨¡å—ï¼š

 #pkg **contents** pkg /   
README.md   
 wasm\_fetch\_example.d.ts   
 wasm\_fetch\_example\_bg.d.ts   
 package.json   
 wasm\_fetch\_example.js   
 wasm\_fetch\_example\_bg.wasm

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ`wasm-pack`å®ƒä¸ä»…ä»…`.wasm`ä¸ºæˆ‘ä»¬è¾“å‡ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼š

*   `package.json`å·²ç”ŸæˆA ï¼Œå°†æ­¤ç›®å½•è§†ä¸ºæ¨¡å—æœ¬èº«ï¼Œå‡†å¤‡å‘å¸ƒåˆ°NPMæˆ–å…¶ä»–ç›®å½•ï¼ˆæˆ‘ä»¬å°†ç®€è¦ä»‹ç»å¦‚ä½•å°†æ¨¡å—å‘å¸ƒåˆ°ç§æœ‰æ³¨å†Œè¡¨ä¸­ï¼‰
*   `.d.ts`åœ¨å°†æ¨¡å—å¯¼å…¥åŸºäºTypescriptçš„é¡¹ç›®æ—¶ï¼Œå·²ä¸ºæ¨¡å—å’Œå‘¨å›´ç»‘å®šå‡½æ•°ç”Ÿæˆç±»å‹å®šä¹‰æ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶åŒ…å«æ¯ä¸ª`export`wasmæ¨¡å—çš„ç±»å‹\- è¿™äº›ç±»å‹å¯ä»¥æ˜¯å¸¸é‡ï¼Œå‡½æ•°ç±»ç­‰
*   `wasm_fetch_example.js` åŒ…å«ä¸wasmæ¨¡å—æœ¬èº«çš„Javascriptç»‘å®š
*   æ‚¨`README.md`ä¹Ÿå°†è¢«å¤åˆ¶åˆ°åŒ…ä¸­ï¼Œä»¥æä¾›æœ‰å…³è¯¥æ¨¡å—çš„æ–‡æ¡£

`wasm-pack`å·²å®Œæˆæ ¼å¼åŒ–é¡¹ç›®çš„å·¥ä½œï¼Œå‡†å¤‡ä½œä¸ºæ¨¡å—å‘å¸ƒï¼Œå¹¶æ”¯æŒJavascriptåŠå…¶Typescriptè¶…é›†ã€‚ç¼–è¯‘åï¼Œæ‚¨å¯èƒ½ä¼šåœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°æ­¤è­¦å‘Šï¼š

\> Cargo.tomlä¸­ç¼ºå°‘å¯é€‰å­—æ®µï¼š'description'ï¼Œ'repository'å’Œ'license'ã€‚è¿™äº›ä¸æ˜¯å¿…éœ€çš„ï¼Œä½†å»ºè®®ä½¿ç”¨

`wasm-pack`å°†å°è¯•ä»æ­¤`Cargo.toml`å¡«å……æ­¤ä¿¡æ¯`package.json`ã€‚æ‚¨ç¡®å®å¯ä»¥åœ¨`Cargo.toml`ä»¥ä¸‹`[package]`éƒ¨åˆ†ä¸­è¾“å…¥æ­¤ä¿¡æ¯ï¼š

**#Cargo.toml** \[package\]   
description =â€œä¸€ä¸ªåŸºäºRustçš„WebAssemblyé¡¹ç›®ï¼Œé€šè¿‡wasm-bindgenå®ç°è·å–è¯·æ±‚ã€‚â€   
license =â€œMITâ€   
repository =â€œ **<your\_repo\_url>â€**ï¼Œ  
...

**_æ³¨æ„ï¼š_**_åç»­æ„å»ºè¦å¿«å¾—å¤šï¼Œåªéœ€é‡æ–°ç¼–è¯‘æ‚¨æ‰€åšçš„æ›´æ”¹ã€‚_

* * *

å‘å¸ƒwasmæ¨¡å—
========

å¦‚æœæ‚¨å¸Œæœ›å…¬å¼€å‘å¸ƒWebAssemblyæ¨¡å—ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`[pack](https://rustwasm.github.io/wasm-pack/book/commands/pack-and-publish.html)`[å’Œ](https://rustwasm.github.io/wasm-pack/book/commands/pack-and-publish.html)`[publish](https://rustwasm.github.io/wasm-pack/book/commands/pack-and-publish.html)`[å‘½ä»¤](https://rustwasm.github.io/wasm-pack/book/commands/pack-and-publish.html) `wasm-pack`æä¾›ï¼š

*   `wasm-pack pack`ä»`pkg/`ç›®å½•åˆ›å»ºä¸€ä¸ªtarball
*   `wasm-pack publish`ä»`pkg/`ç›®å½•åˆ›å»ºä¸€ä¸ªtarball ï¼Œç„¶åå°†å…¶å‘å¸ƒåˆ°å…¬å…±NPMæ³¨å†Œè¡¨

_è¯¥_`_publish_`_å‘½ä»¤åªæ˜¯æŒ‡å‘å‘½ä»¤çš„æŒ‡é’ˆï¼Œè¯¥_`_npm publish_`_å‘½ä»¤æ˜¯å‘å¸ƒåˆ°NPMæ³¨å†Œè¡¨çš„å®˜æ–¹æ–¹å¼ã€‚å› æ­¤ï¼Œæ‰€æœ‰å¯ç”¨çš„æ ‡å¿—_`_npm publish_`_ä¹Ÿå¯ç”¨_`_wasm-pack publish_`_ã€‚_

**ï¼ƒå‘å¸ƒåˆ°å…¬å…±npmæ³¨å†Œè¡¨  
** wasm-pack build

æ‚¨å¯èƒ½å¸Œæœ›å°†æ¨¡å—ç§æœ‰åœ°å‘å¸ƒåˆ°ç§æœ‰æ³¨å†Œè¡¨ã€‚æˆ‘å·²ç»å‘å¸ƒäº†ä¸€ç¯‡å…³äºå¦‚ä½•ä½¿ç”¨ç§æœ‰ä»£ç†æ³¨å†Œè¡¨Verdaccioè®¾ç½®æ­¤ç±»æ³¨å†Œè¡¨çš„æ–‡ç« ã€‚è¯·é˜…è¯»ä»¥ä¸‹æ–‡ç« ä¸­çš„æ“ä½œæ–¹æ³•ï¼š

[

ä½¿ç”¨Proxy Registry Verdaccioå‘å¸ƒç§æœ‰NPMåŒ…


--------------------------------------

### 

å¦‚ä½•åœ¨ä¿æŒå¯¹å…¬å…±npmæ³¨å†Œè¡¨çš„è®¿é—®æƒé™çš„åŒæ—¶ç§ä¸‹å‘å¸ƒåŒ…

#### 

medium.com



](/@rossbulat/publish-private-npm-packages-with-proxy-registry-verdaccio-56b769bca659?source=post_page-----5554b8982402----------------------)

è®¾ç½®ç§æœ‰æ³¨å†Œè¡¨åï¼Œåªéœ€æä¾›å¸¦æœ‰`--registry`æ ‡å¿—çš„URL ï¼š

**ï¼ƒå‘å¸ƒåˆ°ç§æœ‰æ³¨å†Œè¡¨  
** wasm-pack publish --registryâ€œhttpï¼š// <your\_registry\_ip\_or\_domain>â€

è¿™æä¾›äº†ä¸€ç§åœ¨å†…éƒ¨æµ‹è¯•WebAssemblyåº“çš„æ–¹æ³• - å¯¹äºéšç€è§„èŒƒçš„å‘å±•è€Œè¿­ä»£å¼€å‘WebAssemblyæ¨¡å—çš„ç»„ç»‡è€Œè¨€ï¼Œè¿™æ˜¯ä¸€ç§æ›´ç°å®çš„æ–¹æ¡ˆã€‚

`wasm-pack`ç°åœ¨å·²ç»å‘æŒ¥äº†ä½œç”¨ï¼Œå®ƒçš„ä½œç”¨åœ¨å‘å¸ƒè¿‡ç¨‹ä¹‹ååœæ­¢ï¼Œæˆ‘ä»¬çš„æ¨¡å—å‡†å¤‡ä½œä¸ºä¾èµ–é¡¹æ·»åŠ åˆ°é¡¹ç›®ä¸­ã€‚ç°åœ¨è®©æˆ‘ä»¬æ¢è®¨å¦‚ä½•åœ¨Reacté¡¹ç›®ä¸­ä½¿ç”¨wasmæ¨¡å—ã€‚

* * *

å¯¼å…¥wasmæ¨¡å—
========

ä¸ºäº†æµ‹è¯•è·å–åŠŸèƒ½ï¼Œæˆ‘åœ¨è¿™ç¯‡æ–‡ç« çš„éšé™„å­˜å‚¨åº“ä¸­åŒ…å«äº†ä¸€ä¸ªåŸºæœ¬çš„[Create React Appé¡¹ç›®](https://github.com/rossbulat/wasm-fetch-example/tree/master/client)ã€‚

ä¸ºäº†ä¿æŠ¤è¯»è€…ä¸è¦å‘å¸ƒwasmæ¨¡å—æœ¬èº«ç”¨äºè¿™ä¸ªé¡¹ç›®ï¼Œæˆ‘å°†å®ƒåŒ…å«åœ¨å†…éƒ¨`node_modules`ï¼Œå¿½ç•¥äº†é™¤æ­¤æ¨¡å—ä¹‹å¤–çš„æ•´ä¸ªç›®å½•ï¼š

**// .gitignore** client / node\_modules / \*   
ï¼/ client / node\_modules / wasm-fetch-example   
...

ä¿®æ”¹Create React Appä»¥æ”¯æŒwasmæ¨¡å—
---------------------------

Create React Appå½“å‰ä¸æ”¯æŒWebpacké…ç½®ä¸­åŸºäºWebAssemblyçš„æ¨¡å—ã€‚

**_æ³¨æ„ï¼š_**[_ECMAè„šæœ¬æ¨¡å—é›†æˆ_](https://github.com/webassembly/esm-integration)_ç›®å‰æ˜¯ä¸€ä¸ªæ´»è·ƒçš„WebAssemblyæè®® - ä¸€æ—¦è¿™äº›åŠŸèƒ½æœ€ç»ˆç¡®å®šå¹¶æ¨å‡ºï¼Œæˆ‘ä»¬å¯ä»¥æœŸå¾…æ›´ç®€åŒ–çš„é›†æˆè¿‡ç¨‹ã€‚_[](https://github.com/webassembly/esm-integration)

è¿™ä¹Ÿå¾ˆå¯èƒ½æ˜¯çŸ­æœŸé—®é¢˜ï¼Œå¹¶ä¸”éšç€WebAssemblyè·å¾—æ›´å¤šé‡‡ç”¨è€Œå¾—åˆ°è§£å†³ - ä½†æ˜¯æœ‰ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚

ä¸ºäº†æ”¯æŒæˆ‘ä»¬æ–°å‘å¸ƒçš„æ¨¡å—ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹Create React Appçš„Webpacké…ç½®ï¼Œæ·»åŠ ä¸€ä¸ªwasm loaderã€‚æˆ‘ä»¬ç¡®å®å¯ä»¥åœ¨æ²¡æœ‰å¼¹å‡ºCRAçš„æƒ…å†µä¸‹ä½¿ç”¨ä¸€ä¸ªåä¸ºçš„åŒ…`[react-app-rewired](https://www.npmjs.com/package/react-app-rewired)`ï¼ŒåŒæ—¶`[wasm-loader](https://www.npmjs.com/package/wasm-loader)`å‘Webpackæ·»åŠ WebAssemblyæ”¯æŒã€‚

è¿™äº›å·²ä½œä¸ºdevä¾èµ–é¡¹å®‰è£…ï¼š

yarn add react-app-rewired wasm-loader --dev

`[config-overrides.js](https://github.com/rossbulat/wasm-fetch-example/blob/master/client/config-overrides.js)`å·²åœ¨å®¢æˆ·ç«¯çš„æ ¹ç›®å½•ä¸­å®šä¹‰äº†ä¸€ä¸ªè„šæœ¬ï¼Œè¯¥è„šæœ¬æ’å…¥äº†å¯¹åŸºäºwasmçš„æ¨¡å—çš„æ”¯æŒã€‚

è¿™é‡Œçš„æœ€åä¸€ä¸ªä¿®æ”¹æ˜¯åœ¨`package.json`æˆ‘ä»¬è°ƒç”¨çš„åœ°æ–¹ï¼Œ`react-app-rewired`è€Œä¸æ˜¯`react-scripts`åœ¨ç¼–è¯‘å’Œè¿è¡Œåº”ç”¨ç¨‹åºæ—¶ï¼š

**//çš„package.json** â€œè„šæœ¬â€ï¼š{   
 â€œå¼€å§‹â€ï¼š â€œ **ååº”-APP-é‡æ–°å¸ƒçº¿**å¼€å§‹â€ï¼Œ   
 â€œ å»ºç«‹â€ï¼š â€œ **ååº”-APP-é‡æ–°å¸ƒçº¿**çš„æ„å»ºâ€ï¼Œ   
 â€œ æµ‹è¯•â€ï¼š â€œ **ååº”-APP-é‡æ–°å¸ƒçº¿**æµ‹è¯•â€ï¼Œ   
 ã€‚..   
}

å¼‚æ­¥å¯¼å…¥wasmæ¨¡å—
----------

`App.tsx` æ¼”ç¤ºäº†å¦‚ä½•å¼‚æ­¥å¯¼å…¥wasmæ¨¡å—å¹¶å°†å…¶åŠ è½½åˆ°ç»„ä»¶çš„çŠ¶æ€ã€‚

è¿™æ˜¯å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼š

* * *

ç»¼ä¸Šæ‰€è¿°
====

æœ¬æ–‡æ—¨åœ¨ä»‹ç»ä»Rustæ„å»ºWebAsssemblyæ¨¡å—çš„è¿‡ç¨‹ï¼Œ`wasm-pack`ä»¥åŠç”Ÿæˆå’Œç¼–è¯‘æœ€ç»ˆæ¨¡å—çš„æ–¹æ³•ã€‚æˆ‘ä»¬å·²ç»ç¡®å®šï¼š

*   è¿™`wasm-bindgen`ä¸ºæˆ‘ä»¬æä¾›äº†å¯¹Javascriptæ ‡å‡†åº“å’Œæ ‡å‡†Web APIåº“çš„ç»‘å®šï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿè®¿é—®è°ƒç”¨Javascriptï¼Œæ“ä½œDOMï¼Œè·å–çª—å£å’Œäº‹ä»¶æ•°æ®ç­‰ - æ‰€æœ‰è¿™äº›éƒ½æ¥è‡ªæˆ‘ä»¬çš„Rust wasmæ¨¡å—
*   `wasm-pack` æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„å·¥å…·ï¼Œç”¨äºç”ŸæˆåŸºäºRustçš„WebAssemblyé¡¹ç›®ï¼Œå¹¶è‡ªåŠ¨ç¼–è¯‘wasmçš„è¿‡ç¨‹å¹¶å‡†å¤‡å°†ç»“æœåŒ…ä½œä¸ºæ¨¡å—å‘å¸ƒ
*   é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ›å»ºReact Appå½“å‰ä¸æ”¯æŒå…¶Webpacké…ç½®ä¸­çš„.wasmæ¨¡å—æ‰©å±•ã€‚è¦å°†WebAssemblyæ”¾å…¥ç»„ä»¶ä¸­ï¼Œ`react-app-rewired`å¯ä»¥ä½¿ç”¨è¯¥è½¯ä»¶åŒ…å°†wasm-loaderæ’å…¥Webpacké…ç½®ï¼Œæ‰©å±•CRAé…ç½®ï¼Œè€Œæ— éœ€å¼¹å‡ºé¡¹ç›®
*   é€šè¿‡Promiseså¼‚æ­¥å¯¼å…¥wasmæ¨¡å—ä¸ä¼šä¸­æ–­æ‚¨çš„åº”ç”¨ç¨‹åºæµã€‚å¯ä»¥ä½¿ç”¨åŠ è½½æŒ‡ç¤ºç¬¦æˆ–æç¤ºè®©ç”¨æˆ·çŸ¥é“æ‚¨çš„æ¨¡å—æ­£åœ¨åŠ è½½åˆ°çŠ¶æ€