<link rel="stylesheet" type="text/css" href="../css/blog.css"><div class="cloud-blog-detail-content-wrap the_height"><div class="cloud-blog-detail-content-wrap">
    <div class="cloud-blog-detail-content blog-content-block-0" id="blogContent">
        <p>lucene-analyzers-common-5.5.1.jar</p><p>lucene-core-5.5.1.jar</p><p>lucene-queries-5.5.1.jar</p><p>lucene-queryparser-5.5.1.jar</p><h2>创建索引</h2><pre class="brush:java;toolbar:false">public&nbsp;static&nbsp;void&nbsp;creatMysqlIndex(String&nbsp;configPath,&nbsp;Boolean&nbsp;type)&nbsp;{
try&nbsp;{
reader.close();
}&nbsp;catch&nbsp;(Exception&nbsp;e)&nbsp;{
//&nbsp;TODO&nbsp;Auto-generated&nbsp;catch&nbsp;block
log4j.error(e.getMessage());
}
Directory&nbsp;directory&nbsp;=&nbsp;null;
IndexWriter&nbsp;indexWriter&nbsp;=&nbsp;null;
String&nbsp;sql&nbsp;=&nbsp;"";
try&nbsp;{
File&nbsp;indexFile&nbsp;=&nbsp;new&nbsp;File(configPath+"caseIndex/mysql");
if&nbsp;(!indexFile.exists())&nbsp;{
indexFile.mkdir();
}
directory&nbsp;=&nbsp;FSDirectory.open(Paths.get(configPath+"caseIndex/mysql"));
IndexWriterConfig&nbsp;config&nbsp;=&nbsp;new&nbsp;IndexWriterConfig(analyzer);
config.setMaxBufferedDocs(500);
config.setOpenMode(IndexWriterConfig.OpenMode.CREATE);
indexWriter&nbsp;=&nbsp;new&nbsp;IndexWriter(directory,config);//,&nbsp;type&nbsp;TODO:Conform
//indexWriter.MaxFieldLength(5000);
Document&nbsp;doc&nbsp;=&nbsp;null;
//====================
sql&nbsp;=&nbsp;"select&nbsp;*&nbsp;from&nbsp;tbl_hotq&nbsp;where&nbsp;question&nbsp;is&nbsp;not&nbsp;null&nbsp;and&nbsp;extern&nbsp;=&nbsp;0";
ApplicationContext&nbsp;ac&nbsp;=&nbsp;SpringUtil.getApplicationContext();
UserDAOImpl&nbsp;dao&nbsp;=&nbsp;(UserDAOImpl)ac.getBean("userDao");
List&lt;HashMap&lt;String,String&gt;&gt;&nbsp;ret&nbsp;=&nbsp;dao.query(sql);
for(Iterator&lt;HashMap&lt;String,String&gt;&gt;&nbsp;&nbsp;it=ret.iterator();it.hasNext();){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HashMap&lt;String,String&gt;&nbsp;value=it.next();
doc&nbsp;=&nbsp;new&nbsp;Document();
String&nbsp;ct&nbsp;=&nbsp;&nbsp;value.get("question")&nbsp;==&nbsp;"null"&nbsp;?&nbsp;""&nbsp;:&nbsp;value.get("question");//TODO:confirm&nbsp;null&nbsp;"null"
TextField&nbsp;case_title&nbsp;=&nbsp;new&nbsp;TextField("case_title",ct,&nbsp;Field.Store.YES);
String&nbsp;lid&nbsp;=&nbsp;trimHotQ(ct).toLowerCase();
StringField&nbsp;case_id1&nbsp;=&nbsp;new&nbsp;StringField("case_id",lid,Field.Store.YES);
SortedDocValuesField&nbsp;case_id&nbsp;=&nbsp;new&nbsp;SortedDocValuesField("case_id",new&nbsp;BytesRef(lid));//TODO:confirm&nbsp;fix&nbsp;'?'&nbsp;fix
TextField&nbsp;case_keyword&nbsp;=&nbsp;new&nbsp;TextField("case_keyword","",&nbsp;Field.Store.YES);
TextField&nbsp;case_contents&nbsp;=&nbsp;new&nbsp;TextField("case_contents","",&nbsp;Field.Store.YES);
StoredField&nbsp;case_url&nbsp;=&nbsp;new&nbsp;StoredField("case_url","");
StoredField&nbsp;&nbsp;case_point1&nbsp;=&nbsp;new&nbsp;StoredField("case_point",&nbsp;Integer.parseInt(value.get("qcount")));
SortedNumericDocValuesField&nbsp;case_point&nbsp;=&nbsp;
new&nbsp;SortedNumericDocValuesField("case_point",Integer.parseInt(value.get("qcount")));
doc.add(case_title);
doc.add(case_id1);
doc.add(case_id);
doc.add(case_keyword);
doc.add(case_contents);
doc.add(case_url);
doc.add(case_point1);
doc.add(case_point);
indexWriter.addDocument(doc);
//indexWriter.updateDocument(new&nbsp;Term("case_title",ct),&nbsp;doc);
}
//====================
sql&nbsp;=&nbsp;"select&nbsp;*&nbsp;from&nbsp;tbl_hotq&nbsp;where&nbsp;question&nbsp;is&nbsp;not&nbsp;null&nbsp;and&nbsp;extern&nbsp;=&nbsp;1";
ac&nbsp;=&nbsp;SpringUtil.getApplicationContext();
dao&nbsp;=&nbsp;(UserDAOImpl)ac.getBean("userDao");
ret&nbsp;=&nbsp;dao.query(sql);
for(Iterator&lt;HashMap&lt;String,String&gt;&gt;&nbsp;&nbsp;it=ret.iterator();it.hasNext();){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HashMap&lt;String,String&gt;&nbsp;value=it.next();
doc&nbsp;=&nbsp;new&nbsp;Document();
String&nbsp;ct&nbsp;=&nbsp;&nbsp;value.get("question")&nbsp;==&nbsp;"null"&nbsp;?&nbsp;""&nbsp;:&nbsp;value.get("question");//TODO:confirm&nbsp;null&nbsp;"null"
TextField&nbsp;case_title&nbsp;=&nbsp;new&nbsp;TextField("case_title",ct,&nbsp;Field.Store.YES);
String&nbsp;lid&nbsp;=&nbsp;trimHotQ(ct).toLowerCase();
StringField&nbsp;case_id1&nbsp;=&nbsp;new&nbsp;StringField("case_id",lid,Field.Store.YES);
SortedDocValuesField&nbsp;case_id&nbsp;=&nbsp;new&nbsp;SortedDocValuesField("case_id",new&nbsp;BytesRef(lid));
TextField&nbsp;case_keyword=&nbsp;new&nbsp;TextField("case_keyword","",&nbsp;Field.Store.YES);
TextField&nbsp;case_contents&nbsp;=&nbsp;new&nbsp;TextField("case_contents","",&nbsp;Field.Store.YES);
StoredField&nbsp;case_url&nbsp;=&nbsp;new&nbsp;StoredField("case_url",value.get("template")&nbsp;==&nbsp;null&nbsp;?&nbsp;""&nbsp;:&nbsp;value.get("template"));
StoredField&nbsp;&nbsp;case_point1&nbsp;=&nbsp;new&nbsp;StoredField("case_point",&nbsp;Integer.parseInt(value.get("qcount")));
SortedNumericDocValuesField&nbsp;case_point&nbsp;=&nbsp;
new&nbsp;SortedNumericDocValuesField("case_point",Integer.parseInt(value.get("qcount")));
doc.add(case_title);
doc.add(case_id1);
doc.add(case_id);
doc.add(case_keyword);
doc.add(case_contents);
doc.add(case_url);
doc.add(case_point1);
doc.add(case_point);
Term&nbsp;term&nbsp;=&nbsp;new&nbsp;Term("case_id",lid);
Query&nbsp;query&nbsp;=&nbsp;new&nbsp;TermQuery(term);
indexWriter.deleteDocuments(query);
indexWriter.updateDocument(term,doc);
}
//====================
indexWriter.commit();
indexWriter.close();
}&nbsp;catch&nbsp;(Exception&nbsp;e)&nbsp;{
log4j.error(Debug.getFileName()&nbsp;+&nbsp;":"&nbsp;+&nbsp;Debug.getLineNumber()&nbsp;+&nbsp;":"
+&nbsp;e.toString());
}
}</pre><h3>查询</h3><pre class="brush:java;toolbar:false">public&nbsp;String&nbsp;doSearch(String[]&nbsp;queryStr,int[]&nbsp;startCount,Operator&nbsp;op,String[]&nbsp;queryStr1,String[]&nbsp;queryStr2,String[]&nbsp;queryStr3,boolean&nbsp;fulldetect)&nbsp;throws&nbsp;Exception&nbsp;{
String&nbsp;answer&nbsp;=&nbsp;"[#RQ#]";
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HashSet&lt;String&gt;&nbsp;qSet&nbsp;=&nbsp;new&nbsp;HashSet&lt;String&gt;();
if&nbsp;(queryStr[0].isEmpty())&nbsp;{
return&nbsp;answer;
}
if&nbsp;(queryStr[0].startsWith("?")&nbsp;||&nbsp;queryStr[0].startsWith("*"))&nbsp;{
return&nbsp;answer;
}
ArrayList&lt;QaDetail&gt;&nbsp;srt&nbsp;=&nbsp;new&nbsp;ArrayList&lt;QaDetail&gt;();
int&nbsp;n&nbsp;=&nbsp;startCount[0];
MultiFieldQueryParser&nbsp;qp&nbsp;=&nbsp;null;
Query&nbsp;query&nbsp;=&nbsp;null;
//兼容对数据库中tbl_case表中内容的搜索
IndexSearcher&nbsp;searcher&nbsp;=&nbsp;new&nbsp;IndexSearcher(reader);
TopFieldDocs&nbsp;hits&nbsp;=&nbsp;null;
String[]&nbsp;mysqlFields&nbsp;=&nbsp;{&nbsp;"case_title",&nbsp;"case_keyword",
"case_contents","case_point","case_id"&nbsp;};
qp&nbsp;=&nbsp;new&nbsp;MultiFieldQueryParser(mysqlFields,analyzer);
qp.setDefaultOperator(op);
query&nbsp;=&nbsp;qp.parse(queryStr[0]);
qSet.add(trimHotQ(queryStr[1]));
//&nbsp;String[]&nbsp;keywords&nbsp;=&nbsp;processKeyword(keywordSet,queryStr);
//FilteredQuery&nbsp;fq&nbsp;=&nbsp;new&nbsp;FilteredQuery(query,&nbsp;filter);&nbsp;
BooleanClause&nbsp;q1&nbsp;=&nbsp;new&nbsp;BooleanClause(query,&nbsp;BooleanClause.Occur.SHOULD);
BooleanClause&nbsp;q2&nbsp;=&nbsp;null;
BooleanClause&nbsp;q3&nbsp;=&nbsp;null;
BooleanClause&nbsp;q4&nbsp;=&nbsp;null;
if(queryStr1!=null)
{
&nbsp;&nbsp;&nbsp;&nbsp;query&nbsp;=&nbsp;qp.parse(queryStr1[0]);
&nbsp;&nbsp;&nbsp;&nbsp;qSet.add(trimHotQ(queryStr1[1]));
&nbsp;&nbsp;&nbsp;&nbsp;q2&nbsp;=&nbsp;new&nbsp;BooleanClause(query,&nbsp;BooleanClause.Occur.SHOULD);
}
if(queryStr2!=null)
{
&nbsp;&nbsp;&nbsp;&nbsp;query&nbsp;=&nbsp;qp.parse(queryStr2[0]);
&nbsp;&nbsp;&nbsp;&nbsp;qSet.add(trimHotQ(queryStr2[1]));
q3&nbsp;=&nbsp;new&nbsp;BooleanClause(query,&nbsp;BooleanClause.Occur.SHOULD);
}
if(queryStr3!=null)
{
&nbsp;&nbsp;&nbsp;&nbsp;query&nbsp;=&nbsp;qp.parse(queryStr3[0]);
&nbsp;&nbsp;&nbsp;&nbsp;qSet.add(trimHotQ(queryStr3[1]));
q4&nbsp;=&nbsp;new&nbsp;BooleanClause(query,&nbsp;BooleanClause.Occur.SHOULD);
}
BooleanQuery&nbsp;booleanQuery&nbsp;=&nbsp;null;
if(q2!=null&nbsp;&amp;&amp;&nbsp;q3!=null&nbsp;&amp;&amp;&nbsp;q4!=null)&nbsp;{
booleanQuery&nbsp;=&nbsp;new&nbsp;BooleanQuery.Builder().add(q1).add(q2).add(q3).add(q4).build();
&nbsp;&nbsp;&nbsp;&nbsp;}else&nbsp;if(q2!=null&nbsp;&amp;&amp;&nbsp;q3!=null){
&nbsp;&nbsp;&nbsp;&nbsp;booleanQuery&nbsp;=&nbsp;new&nbsp;BooleanQuery.Builder().add(q1).add(q2).add(q3).build();
}else&nbsp;if(q2!=null)&nbsp;{
booleanQuery&nbsp;=&nbsp;new&nbsp;BooleanQuery.Builder().add(q1).add(q2).build();
}else
{
booleanQuery&nbsp;=&nbsp;new&nbsp;BooleanQuery.Builder().add(q1).build();
}
final&nbsp;SortField&nbsp;sfield&nbsp;=&nbsp;new&nbsp;SortedNumericSortField("case_point",&nbsp;SortField.Type.LONG,true);
final&nbsp;SortField&nbsp;iField&nbsp;=&nbsp;new&nbsp;SortField("case_id",SortField.Type.STRING,true);
//DuplicateFilter&nbsp;filter&nbsp;=&nbsp;new&nbsp;DuplicateFilter("case_id",DuplicateFilter.KM_USE_FIRST_OCCURRENCE,DuplicateFilter.PM_FULL_VALIDATION);&nbsp;filter
hits&nbsp;=&nbsp;searcher.search(booleanQuery,20,new&nbsp;Sort(new&nbsp;SortField[]&nbsp;{sfield,iField}));//iField,
ScoreDoc[]&nbsp;sortedHits&nbsp;=hits.scoreDocs;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
//================================
ApplicationContext&nbsp;ac&nbsp;=&nbsp;SpringUtil.getApplicationContext();
UserDAOImpl&nbsp;dao&nbsp;=&nbsp;(UserDAOImpl)ac.getBean("userDao");
&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;sql&nbsp;=&nbsp;"select&nbsp;*&nbsp;from&nbsp;tbl_hotq&nbsp;where&nbsp;id=?";
&nbsp;&nbsp;&nbsp;&nbsp;List&lt;HashMap&lt;String,String&gt;&gt;&nbsp;ret&nbsp;=&nbsp;null;
&nbsp;&nbsp;&nbsp;&nbsp;QaDetail&nbsp;fullmatch&nbsp;=&nbsp;null;
&nbsp;&nbsp;&nbsp;&nbsp;if(fulldetect)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(String&nbsp;vu&nbsp;:&nbsp;qSet)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;dao.query(sql,&nbsp;vu);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(ret.size()==1)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//存在完全匹配的情况
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fullmatch&nbsp;=&nbsp;new&nbsp;QaDetail(Integer.parseInt(ret.get(0).get("qcount")),ret.get(0).get("question"),ret.get(0).get("template"),ret.get(0).get("extern").equals("0")?0:1);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
//================================
for&nbsp;(int&nbsp;j&nbsp;=&nbsp;0;&nbsp;j&nbsp;&lt;&nbsp;sortedHits.length&nbsp;&amp;&amp;&nbsp;j&nbsp;&lt;&nbsp;100;&nbsp;j++)&nbsp;{
int&nbsp;docId&nbsp;=&nbsp;sortedHits[j].doc;
Document&nbsp;doc&nbsp;=&nbsp;searcher.doc(docId);
if&nbsp;(libName.equalsIgnoreCase(doc.get("producttype"))
||&nbsp;libName.equalsIgnoreCase("all"))&nbsp;{
//tbl_case内容的处理分支
if&nbsp;(doc.get("case_title")&nbsp;!=&nbsp;null)&nbsp;{
String&nbsp;case_title&nbsp;=&nbsp;doc.get("case_title");
String&nbsp;case_url&nbsp;=&nbsp;doc.get("case_url");
String&nbsp;case_id&nbsp;=&nbsp;doc.get("case_id");
//int&nbsp;qcount&nbsp;&nbsp;=&nbsp;Integer.parseInt(doc.get("case_point"));
int&nbsp;qcount&nbsp;&nbsp;=&nbsp;0;
try{
qcount&nbsp;=&nbsp;Integer.parseInt(doc.get("case_point"));
}catch(Exception&nbsp;e){
}
if(fullmatch!=null)
{
srt&nbsp;=&nbsp;new&nbsp;ArrayList&lt;QaDetail&gt;();
srt.add(fullmatch);
n&nbsp;=&nbsp;2;
break;
}
if(fulldetect&nbsp;&amp;&amp;&nbsp;qSet.contains(case_id))//完全匹配判断
{
srt&nbsp;=&nbsp;new&nbsp;ArrayList&lt;QaDetail&gt;();
srt.add(new&nbsp;QaDetail(qcount,case_title,case_url,case_url.equals("")?0:1));
n&nbsp;=&nbsp;2;
break;
}
srt.add(new&nbsp;QaDetail(qcount,case_title,case_url,case_url.equals("")?0:1));
}
n++;
if&nbsp;(n&nbsp;&gt;&nbsp;maxSearchResult)
{
//Collections.sort(srt);
for&nbsp;(int&nbsp;c=0;c&lt;srt.size();++c)&nbsp;//Math.min(maxSearchResult,)
{&nbsp;
QaDetail&nbsp;value&nbsp;=&nbsp;srt.get(c);
if(0==value.Catelog)
{
&nbsp;&nbsp;answer&nbsp;+=&nbsp;"[FAQ]"&nbsp;+&nbsp;(startCount[0]+c)&nbsp;+&nbsp;".&nbsp;"&nbsp;+&nbsp;"&lt;a&nbsp;onclick=\"getRelateAnswer('"+value.Question+"');return&nbsp;false;\"&gt;"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;value.Question&nbsp;+&nbsp;"&lt;/a&gt;[/FAQ]";
}else{
&nbsp;&nbsp;answer&nbsp;+=&nbsp;"[FAQ]"&nbsp;+&nbsp;(startCount[0]+c)&nbsp;+&nbsp;".&nbsp;"&nbsp;+&nbsp;"&lt;a&nbsp;href=\""
&nbsp;+&nbsp;value.Url&nbsp;+&nbsp;"\"&nbsp;"&nbsp;+&nbsp;"target=\"_blank\"&gt;"
&nbsp;+&nbsp;value.Question&nbsp;+&nbsp;"&lt;/a&gt;[/FAQ]";
}
}
startCount[0]&nbsp;=&nbsp;n;
return&nbsp;answer&nbsp;+=&nbsp;"\n找不到。\n";
}
}
}
//Collections.sort(srt);
for&nbsp;(int&nbsp;c=0;c&lt;srt.size();++c)&nbsp;&nbsp;
{&nbsp;
QaDetail&nbsp;value&nbsp;=&nbsp;srt.get(c);
if(0==value.Catelog)
{
&nbsp;&nbsp;answer&nbsp;+=&nbsp;"[FAQ]"&nbsp;+&nbsp;(startCount[0]+c)&nbsp;+&nbsp;".&nbsp;"&nbsp;+&nbsp;"&lt;a&nbsp;onclick=\"getRelateAnswer('"+value.Question+"');return&nbsp;false;\"&gt;"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;value.Question&nbsp;+&nbsp;"&lt;/a&gt;[/FAQ]";
}else{
&nbsp;&nbsp;answer&nbsp;+=&nbsp;"[FAQ]"&nbsp;+&nbsp;(startCount[0]+c)&nbsp;+&nbsp;".&nbsp;"&nbsp;+&nbsp;"&lt;a&nbsp;href=\""
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;value.Url&nbsp;+&nbsp;"\"&nbsp;"&nbsp;+&nbsp;"target=\"_blank\"&gt;"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;value.Question&nbsp;+&nbsp;"&lt;/a&gt;[/FAQ]";
}
}
startCount[0]&nbsp;=&nbsp;n;
return&nbsp;answer;
}
public&nbsp;static&nbsp;void&nbsp;initCaseIndexReader(String&nbsp;configPath)&nbsp;{
File&nbsp;directoryCase&nbsp;=&nbsp;new&nbsp;File(configPath+&nbsp;"caseIndex");
File[]&nbsp;indexDirCase&nbsp;=&nbsp;directoryCase.listFiles();
int&nbsp;dirLenghtCase&nbsp;=&nbsp;indexDirCase.length;
indexReaders&nbsp;=&nbsp;new&nbsp;IndexReader[dirLenghtCase];
for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;dirLenghtCase;&nbsp;i++)&nbsp;{
try&nbsp;{
String&nbsp;tempPath&nbsp;=&nbsp;indexDirCase[i].getAbsolutePath();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Directory&nbsp;indexDirectory&nbsp;=&nbsp;FSDirectory.open(Paths.get(tempPath));
indexReaders[i]&nbsp;=&nbsp;DirectoryReader.open(indexDirectory);
}&nbsp;catch&nbsp;(IOException&nbsp;e)&nbsp;{
e.printStackTrace();
}
}
try&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;reader&nbsp;=&nbsp;new&nbsp;MultiReader(indexReaders);
}catch(Exception&nbsp;e)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;log4j.error(e.getMessage());
}
}</pre><h3>更新</h3><p><br></p><pre class="brush:java;toolbar:false">public&nbsp;void&nbsp;updateHotCount(String&nbsp;question)&nbsp;{
String&nbsp;configPath&nbsp;=&nbsp;this.getClass().getResource("/").getPath().substring(1);
List&lt;HashMap&lt;String,String&gt;&gt;&nbsp;ret&nbsp;=&nbsp;null;
IndexWriter&nbsp;indexWriter&nbsp;=&nbsp;null;
try&nbsp;{
//DONE:relace&nbsp;&amp;&nbsp;in&nbsp;patern&nbsp;TODO:test
String&nbsp;sql&nbsp;=&nbsp;"update&nbsp;tbl_hotq&nbsp;set&nbsp;qcount=qcount+1&nbsp;where&nbsp;id&nbsp;=&nbsp;?&nbsp;and&nbsp;extern=0";
ApplicationContext&nbsp;ac&nbsp;=&nbsp;SpringUtil.getApplicationContext();
UserDAOImpl&nbsp;dao&nbsp;=&nbsp;(UserDAOImpl)ac.getBean("userDao");
dao.update(sql,&nbsp;trimHotQ(question));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;设置sql语句中的values值&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
sql&nbsp;=&nbsp;"select&nbsp;*&nbsp;from&nbsp;tbl_hotq&nbsp;where&nbsp;id&nbsp;=?&nbsp;and&nbsp;extern&nbsp;=&nbsp;0";
ret&nbsp;=&nbsp;dao.query(sql,trimHotQ(question));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Directory&nbsp;directory&nbsp;=&nbsp;null;
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//更新索引中的
&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;indexFile&nbsp;=&nbsp;new&nbsp;File(configPath+"caseIndex/mysql");
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!indexFile.exists())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;indexFile.mkdir();
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;directory&nbsp;=&nbsp;FSDirectory.open(Paths.get(configPath+"caseIndex/mysql"));
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;分语，使用paoding
&nbsp;&nbsp;&nbsp;&nbsp;IndexWriterConfig&nbsp;config&nbsp;=&nbsp;new&nbsp;IndexWriterConfig(analyzer);
&nbsp;&nbsp;&nbsp;&nbsp;config.setMaxBufferedDocs(500);
&nbsp;&nbsp;&nbsp;&nbsp;config.setOpenMode(IndexWriterConfig.OpenMode.APPEND);
&nbsp;&nbsp;&nbsp;&nbsp;indexWriter&nbsp;=&nbsp;new&nbsp;IndexWriter(directory,config);//,&nbsp;type&nbsp;TODO:Conform
&nbsp;&nbsp;&nbsp;&nbsp;//indexWriter.MaxFieldLength(5000);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;Document&nbsp;doc&nbsp;=&nbsp;null;
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;if(ret.size()&gt;0)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;HashMap&lt;String,String&gt;&nbsp;value&nbsp;=&nbsp;ret.get(0);
&nbsp;&nbsp;&nbsp;&nbsp;doc&nbsp;=&nbsp;new&nbsp;Document();
String&nbsp;ct&nbsp;=&nbsp;&nbsp;value.get("question")&nbsp;==&nbsp;null&nbsp;?&nbsp;""&nbsp;:&nbsp;value.get("question");
TextField&nbsp;case_title&nbsp;=&nbsp;new&nbsp;TextField("case_title",ct,&nbsp;Field.Store.YES);
String&nbsp;lid&nbsp;=&nbsp;trimHotQ(ct).toLowerCase();
StringField&nbsp;case_id1&nbsp;=&nbsp;new&nbsp;StringField("case_id",lid,&nbsp;Field.Store.YES);
SortedDocValuesField&nbsp;case_id&nbsp;=&nbsp;new&nbsp;SortedDocValuesField("case_id",new&nbsp;BytesRef(lid));
TextField&nbsp;case_keyword&nbsp;=&nbsp;new&nbsp;TextField("case_keyword","",&nbsp;Field.Store.YES);
TextField&nbsp;case_contents&nbsp;=&nbsp;new&nbsp;TextField("case_contents","",&nbsp;Field.Store.YES);
StoredField&nbsp;case_url&nbsp;=&nbsp;new&nbsp;StoredField("case_url","");
StoredField&nbsp;&nbsp;case_point1&nbsp;=&nbsp;new&nbsp;StoredField("case_point",&nbsp;Integer.parseInt(value.get("qcount")));
SortedNumericDocValuesField&nbsp;case_point&nbsp;=&nbsp;
new&nbsp;SortedNumericDocValuesField("case_point",Long.parseLong(value.get("qcount")));
doc.add(case_title);
doc.add(case_id1);
doc.add(case_id);
doc.add(case_keyword);
doc.add(case_contents);
doc.add(case_url);
doc.add(case_point1);
doc.add(case_point);
//indexWriter.addDocument(doc);
Term&nbsp;term&nbsp;=&nbsp;new&nbsp;Term("case_id",lid);
Query&nbsp;query&nbsp;=&nbsp;new&nbsp;TermQuery(term);
indexWriter.deleteDocuments(query);
indexWriter.updateDocument(term,doc);
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;
//====================
indexWriter.commit();
indexWriter.close();
}&nbsp;catch&nbsp;(Exception&nbsp;e)&nbsp;{
log4j.error(Debug.getFileName()&nbsp;+&nbsp;":"&nbsp;+&nbsp;Debug.getLineNumber()&nbsp;+&nbsp;":"
+&nbsp;e.toString());
}finally&nbsp;{
if(indexWriter!=null)
{
try&nbsp;{
indexWriter.close();
}&nbsp;catch&nbsp;(Exception&nbsp;e)&nbsp;{
log4j.error(e.getMessage());
}
}
}
if(ret!=null&nbsp;&amp;&amp;&nbsp;ret.size()&gt;0)
{
try&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reader.close();
}catch&nbsp;(Exception&nbsp;e)&nbsp;{
log4j.error(e.getMessage());
}
initCaseIndexReader(configPath);
}
}</pre><p><span style="white-space:pre;"></span><br></p><p><br></p>
    </div>
    
    
    <p class="pc_current ask-tip">登录后可下载附件，请<a href="https://auth.huaweicloud.com/authui/login?service=https://bbs.huaweicloud.com/blogs/107529#attachment&amp;locale=zh-cn">登录</a>或者<a href="https://reg.huaweicloud.com/registerui/public/custom/register.html?locale=zh-cn&amp;service=https://bbs.huaweicloud.com#/register">注册</a></p>

    <!-- 版权声明 start -->
    
   
    
    <!-- 版权声明 end -->

    <div class="blog-menu-footer m-blog-menu-footer-bottom">
        
    </div>
</div></div>