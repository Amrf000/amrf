<link rel="stylesheet" type="text/css" href="../css/blog.css"><div class="cloud-blog-detail-content-wrap the_height"><div class="cloud-blog-detail-content-wrap">
    <div class="cloud-blog-detail-content blog-content-block-0" id="blogContent">
        <p><a rel="nofollow" href="https://www.cnblogs.com/xia-weiwen/p/6806709.html">https://www.cnblogs.com/xia-weiwen/p/6806709.html</a><br></p><p><a rel="nofollow" href="https://blog.csdn.net/xiaoaid01/article/details/17998013">https://blog.csdn.net/xiaoaid01/article/details/17998013</a></p><p><a rel="nofollow" href="http://shouce.jb51.net/qt-beginning/28.html">http://shouce.jb51.net/qt-beginning/28.html</a></p><h1 style="margin-right:0px;margin-bottom:.85em;margin-left:0px;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);margin-top:0px;">第23篇 数据库（三）利用<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">QSqlQuery</code>类执行SQL语句</h1><h2 style="font-size:1.75em;margin-top:1.275em;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">导语</h2><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">SQL即结构化查询语言，是关系数据库的标准语言。前面两节中已经在Qt里利用<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">QSqlQuery</code>类执行了SQL语句，这一节我们将详细讲解该类的使用。需要说明，因为我们重在讲解Qt中的数据库使用，而非专业的讲解数据库知识，所以不会对数据库中的一些知识进行深入讲解。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">环境：Windows Xp + Qt 4.8.4+Qt Creator2.6.2</p><h2 style="font-size:1.75em;margin-top:1.275em;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">目录</h2><ul style="margin-bottom:.85em;padding:0px 0px 0px 2em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);" class="list-paddingleft-2"><li><p>一、创建数据库连接</p></li><li><p>二、操作结果集</p></li><li><p>三、在SQL语句中使用变量</p></li><li><p>四、批处理操作</p></li><li><p>五、事务操作</p></li></ul><h2 style="font-size:1.75em;margin-top:1.275em;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">正文</h2><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">一、创建数据库连接</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">前面我们是在主函数中创建数据库连接，然后打开并使用。实际中为了明了方便，一般将数据库连接单独放在一个头文件中。下面来看一个例子。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">1．新建Qt Gui应用，项目名称为<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">myquery</code>，基类为<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">QMainWindow</code>，类名为<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">MainWindow</code>。完成后打开<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">myquery.pro</code>并将第一行代码更改为：</p><pre style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;white-space:pre-wrap;margin-top:0px;margin-bottom:1.275em;padding:.85em 1em;border:none;color:rgb(51,51,51);overflow:auto;background-color:rgb(247,247,247);letter-spacing:.2px;">QT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+=&nbsp;coregui&nbsp;sql</pre><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">然后保存该文件。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">2．向项目中添加新的C++头文件，名称为<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">connection.</code>h，然后打开该文件，更改如下：</p><pre style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;white-space:pre-wrap;margin-top:0px;margin-bottom:1.275em;padding:.85em 1em;border:none;color:rgb(51,51,51);overflow:auto;background-color:rgb(247,247,247);letter-spacing:.2px;">#ifndef&nbsp;CONNECTION_H#define&nbsp;CONNECTION_H#include&nbsp;&lt;QMessageBox&gt;#include&nbsp;&lt;QSqlDatabase&gt;#include&nbsp;&lt;QSqlQuery&gt;static&nbsp;bool&nbsp;createConnection(){
&nbsp;&nbsp;&nbsp;&nbsp;QSqlDatabase&nbsp;db&nbsp;=&nbsp;QSqlDatabase::addDatabase("QSQLITE");
&nbsp;&nbsp;&nbsp;&nbsp;db.setDatabaseName(":memory:");&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!db.open())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QMessageBox::critical(0,&nbsp;qApp-&gt;tr("Cannot&nbsp;open&nbsp;database"),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qApp-&gt;tr("Unable&nbsp;to&nbsp;establisha&nbsp;database&nbsp;connection."
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),&nbsp;QMessageBox::Cancel);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;QSqlQuery&nbsp;query;
&nbsp;&nbsp;&nbsp;&nbsp;query.exec("create&nbsp;table&nbsp;student&nbsp;(id&nbsp;int&nbsp;primary&nbsp;key,&nbsp;"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"name&nbsp;varchar(20))");
&nbsp;&nbsp;&nbsp;&nbsp;query.exec("insert&nbsp;into&nbsp;student&nbsp;values(0,&nbsp;'first')");
&nbsp;&nbsp;&nbsp;&nbsp;query.exec("insert&nbsp;into&nbsp;student&nbsp;values(1,&nbsp;'second')");
&nbsp;&nbsp;&nbsp;&nbsp;query.exec("insert&nbsp;into&nbsp;student&nbsp;values(2,&nbsp;'third')");
&nbsp;&nbsp;&nbsp;&nbsp;query.exec("insert&nbsp;into&nbsp;student&nbsp;values(3,&nbsp;'fourth')");
&nbsp;&nbsp;&nbsp;&nbsp;query.exec("insert&nbsp;into&nbsp;student&nbsp;values(4,&nbsp;'fifth')");&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;true;
}#endif&nbsp;//&nbsp;CONNECTION_H</pre><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">在这个头文件中我们添加了一个建立连接的函数，使用这个头文件的目的就是要简化主函数中的内容。这里先创建了一个SQLite数据库的默认连接，设置数据库名称时使用了<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">“:memory:”</code>，表明这个是建立在内存中的数据库，也就是说该数据库只在程序运行期间有效，等程序运行结束时就会将其销毁。当然，大家也可以将其改为一个具体的数据库名称，比如<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">“my.db”</code>，这样就会在项目目录中创建该数据库文件了。下面使用<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">open()</code>函数将数据库打开，如果打开失败，则弹出提示对话框。最后使用<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">QSqlQuery</code>创建了一个<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">student</code>表，并插入了包含<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">id</code>和<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">name</code>两个属性的五条记录，如下图所示。其中，<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">id</code>属性是<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">int</code>类型的，<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">“primary key”</code>表明该属性是主键，它不能为空，而且不能有重复的值；而<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">name</code>属性是<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">varchar</code>类型的，并且不大于20个字符。这里使用的SQL语句都要包含在双引号中，如果一行写不完，那么分行后，每一行都要使用两个双引号引起来。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);"><img referrerpolicy="no-referrer" src="http://shouce.jb51.net/qt-beginning/img/23-1.jpg" alt=""></p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">需要注意，代码中的<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">query</code>没有进行任何指定就可以操作前面打开的数据库，这是因为现在只有一个数据库连接，它就是默认连接，这时候所有的操作都是针对该连接的。但是如果要同时操作多个数据库连接，就需要进行指定了，这方面内容可以参考《Qt Creator快速入门》的第17章。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">3．下面我们到<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">main.cpp</code>中调用连接函数。</p><pre style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;white-space:pre-wrap;margin-top:0px;margin-bottom:1.275em;padding:.85em 1em;border:none;color:rgb(51,51,51);overflow:auto;background-color:rgb(247,247,247);letter-spacing:.2px;">#include&nbsp;"mainwindow.h"#include&nbsp;&lt;QApplication&gt;#include&nbsp;"connection.h"int&nbsp;main(int&nbsp;argc,&nbsp;char&nbsp;*argv[]){&nbsp;&nbsp;&nbsp;&nbsp;QApplication&nbsp;a(argc,&nbsp;argv);&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!createConnection())&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1;

&nbsp;&nbsp;&nbsp;&nbsp;MainWindow&nbsp;w;
&nbsp;&nbsp;&nbsp;&nbsp;w.show();&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;a.exec();
}</pre><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">4．我们往界面上添加一个按钮来实现查询操作。双击<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">mainwindow.ui</code>文件进入设计模式。然后将一个<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">Push Button</code>拖到界面上，并修改其显示文本为“查询”。效果如下图所示。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);"><img referrerpolicy="no-referrer" src="http://shouce.jb51.net/qt-beginning/img/23-2.jpg" alt=""></p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">5．在查询按钮上点击鼠标右键，选择“转到槽”，然后选择<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">clicked()</code>单击信号槽并点击确定，如下图所示。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);"><img referrerpolicy="no-referrer" src="http://shouce.jb51.net/qt-beginning/img/23-3.jpg" alt=""></p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">6．将槽的内容更改如下：</p><pre style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;white-space:pre-wrap;margin-top:0px;margin-bottom:1.275em;padding:.85em 1em;border:none;color:rgb(51,51,51);overflow:auto;background-color:rgb(247,247,247);letter-spacing:.2px;">void&nbsp;MainWindow::on_pushButton_clicked()
{
&nbsp;&nbsp;&nbsp;&nbsp;QSqlQuery&nbsp;query;
&nbsp;&nbsp;&nbsp;&nbsp;query.exec("select&nbsp;*&nbsp;from&nbsp;student");&nbsp;&nbsp;&nbsp;&nbsp;while(query.next())
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qDebug()&nbsp;&lt;&lt;&nbsp;query.value(0).toInt()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt;&nbsp;query.value(1).toString();
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">7．在<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">mainwindow.cpp</code>文件中添加头文件：</p><pre style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;white-space:pre-wrap;margin-top:0px;margin-bottom:1.275em;padding:.85em 1em;border:none;color:rgb(51,51,51);overflow:auto;background-color:rgb(247,247,247);letter-spacing:.2px;">#include&nbsp;&lt;QSqlQuery&gt;#include&nbsp;&lt;QDebug&gt;</pre><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">8．运行程序，然后按下查询按钮，在应用程序输出窗口将会输出结果，效果如下图所示。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);"><img referrerpolicy="no-referrer" src="http://shouce.jb51.net/qt-beginning/img/23-4.jpg" alt=""></p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">二、操作结果集</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">在前面的程序中，我们使用<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">query.exec("select * from student");</code>查询出表中所有的内容。其中的SQL语句<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">“select * from student”</code>中<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">“*”</code>号表明查询表中记录的所有属性。而当<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">query.exec("select * from student");</code>这条语句执行完后，我们便获得了相应的执行结果，因为获得的结果可能不止一条记录，所以称之为结果集。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">结果集其实就是查询到的所有记录的集合，在<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">QSqlQuery</code>类中提供了多个函数来操作这个集合，需要注意这个集合中的记录是从0开始编号的。最常用的操作有：</p><ul style="margin-bottom:.85em;padding:0px 0px 0px 2em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);" class="list-paddingleft-2"><li><p><code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">seek(int n)</code>&nbsp;：<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">query</code>指向结果集的第n条记录；</p></li><li><p><code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">first()</code>&nbsp;：<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">query</code>指向结果集的第一条记录；</p></li><li><p><code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">last()</code>&nbsp;：<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">query</code>指向结果集的最后一条记录；</p></li><li><p><code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">next()</code>&nbsp;：<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">query</code>指向下一条记录，每执行一次该函数，便指向相邻的下一条记录；</p></li><li><p><code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">previous()</code>&nbsp;：<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">query</code>指向上一条记录，每执行一次该函数，便指向相邻的上一条记录；</p></li><li><p><code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">record()</code>&nbsp;：获得现在指向的记录；</p></li><li><p><code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">value(int n)</code>&nbsp;：获得属性的值。其中<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">n</code>表示你查询的第n个属性，比方上面我们使用<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">“select * from student</code>”就相当于<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">“select id, name from student”</code>，那么<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">value(0)</code>返回<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">id</code>属性的值，<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">value(1)</code>返回<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">name</code>属性的值。该函数返回<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">QVariant</code>类型的数据，关于该类型与其他类型的对应关系，可以在帮助中查看QVariant。</p></li><li><p><code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">at()</code>&nbsp;：获得现在<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">query</code>指向的记录在结果集中的编号。</p></li></ul><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">需要特别注意，刚执行完<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">query.exec("select *from student");</code>这行代码时，<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">query</code>是指向结果集以外的，我们可以利用<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">query.next()</code>使得&nbsp;<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">query</code>指向结果集的第一条记录。当然我们也可以利用<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">seek(0)</code>函数或者<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">first()</code>函数使<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">query</code>指向结果集的第一条记录。但是为了节省内存开销，推荐的方法是，在<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">query.exec("select * from student");</code>这行代码前加上<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">query.setForwardOnly(true);</code>这条代码，此后只能使用<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">next()</code>和<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">seek()</code>函数。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">下面我们通过例子来演示一下这些函数的使用。将槽更改如下：</p><pre style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;white-space:pre-wrap;margin-top:0px;margin-bottom:1.275em;padding:.85em 1em;border:none;color:rgb(51,51,51);overflow:auto;background-color:rgb(247,247,247);letter-spacing:.2px;">void&nbsp;MainWindow::on_pushButton_clicked()
{
&nbsp;&nbsp;&nbsp;&nbsp;QSqlQuery&nbsp;query;
&nbsp;&nbsp;&nbsp;&nbsp;query.exec("select&nbsp;*&nbsp;from&nbsp;student");
&nbsp;&nbsp;&nbsp;&nbsp;qDebug()&nbsp;&lt;&lt;&nbsp;"exec&nbsp;next()&nbsp;:";&nbsp;&nbsp;&nbsp;&nbsp;//开始就先执行一次next()函数，那么query指向结果集的第一条记录
&nbsp;&nbsp;&nbsp;&nbsp;if(query.next())
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//获取query所指向的记录在结果集中的编号
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;rowNum&nbsp;=&nbsp;query.at();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//获取每条记录中属性（即列）的个数
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;columnNum&nbsp;=&nbsp;query.record().count();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//获取"name"属性所在列的编号，列从左向右编号，最左边的编号为0
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;fieldNo&nbsp;=&nbsp;query.record().indexOf("name");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//获取id属性的值，并转换为int型
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;id&nbsp;=&nbsp;query.value(0).toInt();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//获取name属性的值
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QString&nbsp;name&nbsp;=&nbsp;query.value(fieldNo).toString();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//将结果输出
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qDebug()&nbsp;&lt;&lt;&nbsp;"rowNum&nbsp;is&nbsp;:&nbsp;"&nbsp;&lt;&lt;&nbsp;rowNum
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt;&nbsp;"&nbsp;id&nbsp;is&nbsp;:&nbsp;"&nbsp;&lt;&lt;&nbsp;id
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt;&nbsp;"&nbsp;name&nbsp;is&nbsp;:&nbsp;"&nbsp;&lt;&lt;&nbsp;name
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt;&nbsp;"&nbsp;columnNum&nbsp;is&nbsp;:&nbsp;"&nbsp;&lt;&lt;&nbsp;columnNum;
&nbsp;&nbsp;&nbsp;&nbsp;}//定位到结果集中编号为2的记录，即第三条记录，因为第一条记录的编号为0
&nbsp;&nbsp;&nbsp;&nbsp;qDebug()&nbsp;&lt;&lt;&nbsp;"exec&nbsp;seek(2)&nbsp;:";&nbsp;&nbsp;&nbsp;&nbsp;if(query.seek(2))
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qDebug()&nbsp;&lt;&lt;&nbsp;"rowNum&nbsp;is&nbsp;:&nbsp;"&nbsp;&lt;&lt;&nbsp;query.at()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt;&nbsp;"&nbsp;id&nbsp;is&nbsp;:&nbsp;"&nbsp;&lt;&lt;&nbsp;query.value(0).toInt()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt;&nbsp;"&nbsp;name&nbsp;is&nbsp;:&nbsp;"&nbsp;&lt;&lt;&nbsp;query.value(1).toString();
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;//定位到结果集中最后一条记录
&nbsp;&nbsp;&nbsp;&nbsp;qDebug()&nbsp;&lt;&lt;&nbsp;"exec&nbsp;last()&nbsp;:";&nbsp;&nbsp;&nbsp;&nbsp;if(query.last())
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qDebug()&nbsp;&lt;&lt;&nbsp;"rowNum&nbsp;is&nbsp;:&nbsp;"&nbsp;&lt;&lt;&nbsp;query.at()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt;&nbsp;"&nbsp;id&nbsp;is&nbsp;:&nbsp;"&nbsp;&lt;&lt;&nbsp;query.value(0).toInt()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt;&nbsp;"&nbsp;name&nbsp;is&nbsp;:&nbsp;"&nbsp;&lt;&lt;&nbsp;query.value(1).toString();
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">最后在<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">mainwindow.cpp</code>中添加<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">#include &lt;QSqlRecord&gt;</code>头文件包含，运行程序，点击查询按钮，输出结果如下图所示。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);"><img referrerpolicy="no-referrer" src="http://shouce.jb51.net/qt-beginning/img/23-5.jpg" alt=""></p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">三、在SQL语句中使用变量</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">1．我们先来看一个例子。首先在设计模式往界面上添加一个<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">Spin Box</code>部件，如下图所示。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);"><img referrerpolicy="no-referrer" src="http://shouce.jb51.net/qt-beginning/img/23-6.jpg" alt=""></p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">2．将查询按钮槽里面的内容更改如下：</p><pre style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;white-space:pre-wrap;margin-top:0px;margin-bottom:1.275em;padding:.85em 1em;border:none;color:rgb(51,51,51);overflow:auto;background-color:rgb(247,247,247);letter-spacing:.2px;">void&nbsp;MainWindow::on_pushButton_clicked()
{
&nbsp;&nbsp;&nbsp;&nbsp;QSqlQuery&nbsp;query;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;id&nbsp;=&nbsp;ui-&gt;spinBox-&gt;value();
&nbsp;&nbsp;&nbsp;&nbsp;query.exec(QString("select&nbsp;name&nbsp;from&nbsp;student&nbsp;where&nbsp;id&nbsp;=%1")
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.arg(id));
&nbsp;&nbsp;&nbsp;&nbsp;query.next();
&nbsp;&nbsp;&nbsp;&nbsp;QString&nbsp;name&nbsp;=&nbsp;query.value(0).toString();
&nbsp;&nbsp;&nbsp;&nbsp;qDebug()&nbsp;&lt;&lt;&nbsp;name;
}</pre><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">这里使用了<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">QString</code>类的<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">arg()</code>函数实现了在SQL语句中使用变量，我们运行程序，更改<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">Spin Box</code>的值，然后点击查询按钮，效果如下图所示。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);"><img referrerpolicy="no-referrer" src="http://shouce.jb51.net/qt-beginning/img/23-7.jpg" alt=""></p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">3．其实在<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">QSqlQuery</code>类中提供了数据绑定同样可以实现在SQL语句中使用变量，虽然它也是通过占位符来实现的，不过使用它形式上更明了一些。下面先来看一个例子，将查询按钮槽更改如下：</p><pre style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;white-space:pre-wrap;margin-top:0px;margin-bottom:1.275em;padding:.85em 1em;border:none;color:rgb(51,51,51);overflow:auto;background-color:rgb(247,247,247);letter-spacing:.2px;">void&nbsp;MainWindow::on_pushButton_clicked()
{
&nbsp;&nbsp;&nbsp;&nbsp;QSqlQuery&nbsp;query;
&nbsp;&nbsp;&nbsp;&nbsp;query.prepare("insert&nbsp;into&nbsp;student&nbsp;(id,&nbsp;name)&nbsp;"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"values&nbsp;(:id,&nbsp;:name)");
&nbsp;&nbsp;&nbsp;&nbsp;query.bindValue(0,&nbsp;5);
&nbsp;&nbsp;&nbsp;&nbsp;query.bindValue(1,&nbsp;"sixth");
&nbsp;&nbsp;&nbsp;&nbsp;query.exec();
&nbsp;&nbsp;&nbsp;&nbsp;query.exec("select&nbsp;*&nbsp;from&nbsp;student");
&nbsp;&nbsp;&nbsp;&nbsp;query.last();&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;id&nbsp;=&nbsp;query.value(0).toInt();
&nbsp;&nbsp;&nbsp;&nbsp;QString&nbsp;name&nbsp;=&nbsp;query.value(1).toString();
&nbsp;&nbsp;&nbsp;&nbsp;qDebug()&nbsp;&lt;&lt;&nbsp;id&nbsp;&lt;&lt;&nbsp;name;
}</pre><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">这里在<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">student</code>表的最后又添加了一条记录。然后我们先使用了<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">prepare()</code>函数，在其中利用了<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">“:id”</code>和<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">“:name”</code>来代替具体的数据，而后又利用<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">bindValue()</code>函数给<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">id</code>和<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">name</code>两个属性赋值，这称为绑定操作。其中编号0和1分别代表<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">“:id”</code>和<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">“:name”</code>，就是说按照<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">prepare()</code>函数中出现的属性从左到右编号，最左边是0 。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">特别注意，在最后一定要执行<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">exec()</code>函数，所做的操作才能被真正执行。运行程序，点击查询按钮，可以看到前面添加的记录的信息。这里的<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">“:id”</code>和<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">“:name”</code>，叫做占位符，这是ODBC数据库的表示方法，还有一种Oracle的表示方法就是全部用“？”号。例如：</p><pre style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;white-space:pre-wrap;margin-top:0px;margin-bottom:1.275em;padding:.85em 1em;border:none;color:rgb(51,51,51);overflow:auto;background-color:rgb(247,247,247);letter-spacing:.2px;">query.prepare("insert&nbsp;into&nbsp;student(id,&nbsp;name)&nbsp;"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"values&nbsp;(?,&nbsp;?)");
query.bindValue(0,&nbsp;5);
query.bindValue(1,&nbsp;"sixth");
query.exec();</pre><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">也可以利用<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">addBindValue()</code>函数，这样就可以省去编号，它是按顺序给属性赋值的，如下：</p><pre style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;white-space:pre-wrap;margin-top:0px;margin-bottom:1.275em;padding:.85em 1em;border:none;color:rgb(51,51,51);overflow:auto;background-color:rgb(247,247,247);letter-spacing:.2px;">query.prepare("insert&nbsp;into&nbsp;student(id,&nbsp;name)&nbsp;"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"values&nbsp;(?,&nbsp;?)");
query.addBindValue(5);
query.addBindValue("sixth");
query.exec();</pre><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">当用ODBC的表示方法时，我们也可以将编号用实际的占位符代替，如下：</p><pre style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;white-space:pre-wrap;margin-top:0px;margin-bottom:1.275em;padding:.85em 1em;border:none;color:rgb(51,51,51);overflow:auto;background-color:rgb(247,247,247);letter-spacing:.2px;">query.prepare("insert&nbsp;into&nbsp;student(id,&nbsp;name)&nbsp;"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"values&nbsp;(:id,&nbsp;:name)");
query.bindValue(":id",&nbsp;5);
query.bindValue(":name",&nbsp;"sixth");
query.exec();</pre><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">以上各种形式的表示方式效果是一样的。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">4．下面我们演示一下通过绑定操作在SQL语句中使用变量。更改槽函数如下：</p><pre style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;white-space:pre-wrap;margin-top:0px;margin-bottom:1.275em;padding:.85em 1em;border:none;color:rgb(51,51,51);overflow:auto;background-color:rgb(247,247,247);letter-spacing:.2px;">void&nbsp;MainWindow::on_pushButton_clicked()
{
&nbsp;&nbsp;&nbsp;&nbsp;QSqlQuery&nbsp;query;
&nbsp;&nbsp;&nbsp;&nbsp;query.prepare("select&nbsp;name&nbsp;from&nbsp;student&nbsp;where&nbsp;id&nbsp;=&nbsp;?");&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;id&nbsp;=&nbsp;ui-&gt;spinBox-&gt;value();
&nbsp;&nbsp;&nbsp;&nbsp;query.addBindValue(id);
&nbsp;&nbsp;&nbsp;&nbsp;query.exec();
&nbsp;&nbsp;&nbsp;&nbsp;query.next();
&nbsp;&nbsp;&nbsp;&nbsp;qDebug()&nbsp;&lt;&lt;&nbsp;query.value(0).toString();
}</pre><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">运行程序，可以实现通过<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">Spin Box</code>的值来进行查询。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">四、批处理操作</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">当要进行多条记录的操作时，我们就可以利用绑定进行批处理。将槽更改如下：</p><pre style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;white-space:pre-wrap;margin-top:0px;margin-bottom:1.275em;padding:.85em 1em;border:none;color:rgb(51,51,51);overflow:auto;background-color:rgb(247,247,247);letter-spacing:.2px;">void&nbsp;MainWindow::on_pushButton_clicked()
{
&nbsp;&nbsp;&nbsp;&nbsp;QSqlQuery&nbsp;q;
&nbsp;&nbsp;&nbsp;&nbsp;q.prepare("insert&nbsp;into&nbsp;student&nbsp;values&nbsp;(?,&nbsp;?)");
&nbsp;&nbsp;&nbsp;&nbsp;QVariantList&nbsp;ints;
&nbsp;&nbsp;&nbsp;&nbsp;ints&nbsp;&lt;&lt;&nbsp;10&nbsp;&lt;&lt;&nbsp;11&nbsp;&lt;&lt;&nbsp;12&nbsp;&lt;&lt;&nbsp;13;
&nbsp;&nbsp;&nbsp;&nbsp;q.addBindValue(ints);
&nbsp;&nbsp;&nbsp;&nbsp;QVariantList&nbsp;names;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;最后一个是空字符串，应与前面的格式相同
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;names&nbsp;&lt;&lt;&nbsp;"xiaoming"&nbsp;&lt;&lt;&nbsp;"xiaoliang"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt;&nbsp;"xiaogang"&nbsp;&lt;&lt;&nbsp;QVariant(QVariant::String);
&nbsp;&nbsp;&nbsp;&nbsp;q.addBindValue(names);&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!q.execBatch())&nbsp;//进行批处理，如果出错就输出错误
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qDebug()&nbsp;&lt;&lt;&nbsp;q.lastError();&nbsp;&nbsp;&nbsp;&nbsp;//下面输出整张表
&nbsp;&nbsp;&nbsp;&nbsp;QSqlQuery&nbsp;query;
&nbsp;&nbsp;&nbsp;&nbsp;query.exec("select&nbsp;*&nbsp;from&nbsp;student");&nbsp;&nbsp;&nbsp;&nbsp;while(query.next())
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;id&nbsp;=&nbsp;query.value(0).toInt();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QString&nbsp;name&nbsp;=&nbsp;query.value(1).toString();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qDebug()&nbsp;&lt;&lt;&nbsp;id&nbsp;&lt;&lt;&nbsp;name;
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">然后需要在<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">mainwindow.cpp</code>上添加头文件包含：<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">#include &lt;QSqlError&gt;</code>。我们在程序中利用列表存储了同一属性的多个值，然后进行了值绑定。最后执行<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">execBatch()</code>函数进行批处理。注意程序中利用<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">QVariant(QVariant::String)</code>来输入空值<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">NULL</code>，因为前面都是<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">QString</code>类型的，所以这里要使用<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">QVariant::String</code>&nbsp;使格式一致化。 运行程序，效果如下图所示：</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);"><img referrerpolicy="no-referrer" src="http://shouce.jb51.net/qt-beginning/img/23-8.jpg" alt=""></p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">五、事务操作</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">事务可以保证一个复杂的操作的原子性，就是对于一个数据库操作序列，这些操作要么全部做完，要么一条也不做，它是一个不可分割的工作单位。在Qt中，如果底层的数据库引擎支持事务，那么<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">QSqlDriver::hasFeature(QSqlDriver::Transactions)</code>会返回<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">true</code>。可以使用<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">QSqlDatabase::transaction()</code>来启动一个事务，然后编写一些希望在事务中执行的SQL语句，最后调用<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">QSqlDatabase::commit()</code>或者<code style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:.85em;margin:0px;padding:.2em;border:none;color:inherit;background-color:rgb(247,247,247);">QSqlDatabase::rollback()</code>。当使用事务时必须在创建查询以前就开始事务，例如：</p><pre style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;white-space:pre-wrap;margin-top:0px;margin-bottom:1.275em;padding:.85em 1em;border:none;color:rgb(51,51,51);overflow:auto;background-color:rgb(247,247,247);letter-spacing:.2px;">QSqlDatabase::database().transaction();
QSqlQuery&nbsp;query;
query.exec("SELECT&nbsp;id&nbsp;FROMemployee&nbsp;WHERE&nbsp;name&nbsp;=&nbsp;'Torild&nbsp;Halvorsen'");if&nbsp;(query.next())&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;employeeId&nbsp;=&nbsp;query.value(0).toInt();
&nbsp;&nbsp;&nbsp;&nbsp;query.exec("INSERT&nbsp;INTO&nbsp;project(id,&nbsp;name,&nbsp;ownerid)&nbsp;"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"VALUES&nbsp;(201,&nbsp;'ManhattanProject',&nbsp;"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;QString::number(employeeId)&nbsp;+&nbsp;')');
}
QSqlDatabase::database().commit();</pre><h2 style="font-size:1.75em;margin-top:1.275em;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">结语</h2><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">对执行SQL语句我们就介绍这么多，其实Qt中提供了更为简单的不需要SQL语句就可以操作数据库的方法，我们在下一节讲述这些内容。</p><p style="margin-top:0px;margin-bottom:.85em;color:rgb(51,51,51);font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;letter-spacing:.2px;white-space:normal;background-color:rgb(255,255,255);">涉及到的源码:</p><p><a rel="nofollow" href="https://www.devbean.net/2013/06/qt-study-road-2-database/">https://www.devbean.net/2013/06/qt-study-road-2-database/</a></p><header><h1 class="title single-title entry-title">Qt 学习之路 2（55）：数据库操作</h1><p><span class="theauthor"><em class="fa fa-user"></em> <a rel="nofollow" href="https://www.devbean.net/author/devbean/" title="由豆子发布">豆子</a></span><span class="thetime date updated"><em class="fa fa-calendar"></em> 2013年6月14日</span><span class="thecategory"><em class="fa fa-tags"></em> <a rel="nofollow" href="https://www.devbean.net/category/qt-study-road-2/" title="View all posts in Qt 学习之路 2">Qt 学习之路 2</a></span><span class="thecomment"><em class="fa fa-comments"></em> <a rel="nofollow" href="https://www.devbean.net/2013/06/qt-study-road-2-database/#comments">79条评论</a></span></p></header><p><br></p><p>Qt 提供了 QtSql 模块来提供平台-独立的基于 SQL 的数据库操作。这里我们所说的“平台-独立”，既包括操作系统平台，又包括各个数据库平台。另外，我们强调了“基于 SQL”，因为 NoSQL 数据库至今没有一个通用查询方法，所以不可能提供一种通用的 NoSQL 数据库的操作。Qt 的数据库操作还可以很方便的与 model/view 架构进行整合。通常来说，我们对数据库的操作更多地在于对数据库表的操作，而这正是 model/view 架构的长项。</p><p><br></p><p>Qt 使用<code class="prettyprint">QSqlDatabase</code>表示一个数据库连接。更底层上，Qt 使用驱动（drivers）来与不同的数据库 API 进行交互。Qt 桌面版本提供了如下几种驱动：</p><table><tbody><tr class="firstRow"><td>&nbsp;驱动</td><td>数据库</td></tr><tr><td>QDB2</td><td>IBM DB2 (7.1 或更新版本)</td></tr><tr><td>QIBASE</td><td>Borland InterBase</td></tr><tr><td>QMYSQL</td><td>MySQL</td></tr><tr><td>QOCI</td><td>Oracle Call Interface Driver</td></tr><tr><td>QODBC</td><td>Open Database Connectivity (ODBC) – Microsoft SQL Server 及其它兼容 ODBC 的数据库</td></tr><tr><td>QPSQL</td><td>PostgreSQL (7.3 或更新版本)</td></tr><tr><td>QSQLITE2</td><td>SQLite 2</td></tr><tr><td>QSQLITE</td><td>SQLite 3</td></tr><tr><td>QSYMSQL</td><td>针对 Symbian 平台的SQLite 3</td></tr><tr><td>QTDS</td><td>Sybase Adaptive Server (自 Qt 4.7 起废除)</td></tr></tbody></table><p>不过，由于受到协议的限制，Qt 开源版本并没有提供上面所有驱动的二进制版本，而仅仅以源代码的形式提供。通常，Qt 只默认搭载 QSqlite 驱动（这个驱动实际还包括 Sqlite 数据库，也就是说，如果需要使用 Sqlite 的话，只需要该驱动即可）。我们可以选择把这些驱动作为 Qt 的一部分进行编译，也可以当作插件编译。</p><p>如果习惯于使用 SQL 语句，我们可以选择<code class="prettyprint">QSqlQuery</code>类；如果只需要使用高层次的数据库接口（不关心 SQL 语法），我们可以选择<code class="prettyprint">QSqlTableModel</code>和<code class="prettyprint">QSqlRelationalTableModel</code>。本章我们介绍<code class="prettyprint">QSqlQuery</code>类，在后面的章节则介绍<code class="prettyprint">QSqlTableModel</code>和<code class="prettyprint">QSqlRelationalTableModel</code>。</p><p>在使用时，我们可以通过</p><p>C/C++</p><p>1 lines</p><p><em class="mivhak-icon copy-icon"></em></p><p><em class="mivhak-icon expand-icon"></em></p><p><em class="mivhak-icon wrap-icon"></em></p><p><em class="mivhak-icon info-icon"></em></p><pre class="prettyprint lang-c_cpp ace_editor ace-xcode" style="font-size:14px;height:17px;">QSqlDatabase::drivers();</pre><p>找到系统中所有可用的数据库驱动的名字列表。我们只能使用出现在列表中的驱动。由于默认情况下，QtSql 是作为 Qt 的一个模块提供的。为了使用有关数据库的类，我们必须早 .pro 文件中添加这么一句：</p><pre>QT&nbsp;+=&nbsp;sql</pre><p>这表示，我们的程序需要使用 Qt 的 core、gui 以及 sql 三个模块。注意，如果需要同时使用 Qt4 和 Qt5 编译程序，通常我们的 .pro 文件是这样的：</p><p>Plain Text</p><p>2 lines</p><p><em class="mivhak-icon copy-icon"></em></p><p><em class="mivhak-icon expand-icon"></em></p><p><em class="mivhak-icon wrap-icon"></em></p><p><em class="mivhak-icon info-icon"></em></p><pre class="prettyprint lang-plain_text ace_editor ace-xcode" style="font-size:14px;height:34px;">QT&nbsp;+=&nbsp;core&nbsp;gui&nbsp;sql
greaterThan(QT_MAJOR_VERSION,&nbsp;4):&nbsp;QT&nbsp;+=&nbsp;widgets</pre><p>这两句也很明确：Qt 需要加载 core、gui 和 sql 三个模块，如果主板本大于 4，则再添加 widgets 模块。</p><p>下面来看一个简单的函数：</p><p>C/C++</p><p>15 lines</p><p><em class="mivhak-icon copy-icon"></em></p><p><em class="mivhak-icon expand-icon"></em></p><p><em class="mivhak-icon wrap-icon"></em></p><p><em class="mivhak-icon info-icon"></em></p><pre class="prettyprint lang-c_cpp ace_editor ace-xcode" style="font-size:14px;height:255px;">bool&nbsp;connect(const&nbsp;QString&nbsp;&amp;dbName)
{
&nbsp;&nbsp;&nbsp;&nbsp;QSqlDatabase&nbsp;db&nbsp;=&nbsp;QSqlDatabase::addDatabase("QSQLITE");
//&nbsp;&nbsp;&nbsp;&nbsp;db.setHostName("host");
//&nbsp;&nbsp;&nbsp;&nbsp;db.setDatabaseName("dbname");
//&nbsp;&nbsp;&nbsp;&nbsp;db.setUserName("username");
//&nbsp;&nbsp;&nbsp;&nbsp;db.setPassword("password");
&nbsp;&nbsp;&nbsp;&nbsp;db.setDatabaseName(dbName);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!db.open())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QMessageBox::critical(0,&nbsp;QObject::tr("Database&nbsp;Error"),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db.lastError().text());
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;true;
}</pre><p>我们使用<code class="prettyprint">connect()</code>函数创建一个数据库连接。我们使用<code class="prettyprint">QSqlDatabase::addDatabase()</code>静态函数完成这一请求，也就是创建了一个<code class="prettyprint">QSqlDatabase</code>实例。注意，数据库连接使用自己的名字进行区分，而不是数据库的名字。例如，我们可以使用下面的语句：</p><p>C/C++</p><p><em class="mivhak-icon copy-icon"></em></p><p><em class="mivhak-icon expand-icon"></em></p><p><em class="mivhak-icon wrap-icon"></em></p><p><em class="mivhak-icon info-icon"></em></p><pre class="prettyprint lang-c_cpp ace_editor ace-xcode" style="font-size:14px;height:17px;">QSqlDatabase&nbsp;db=QSqlDatabase::addDatabase("QSQLITE",&nbsp;QString("con%1").arg(dbName));</pre><p>此时，我们是使用<code class="prettyprint">addDatabase()</code>函数的第二个参数来给这个数据库连接一个名字。在这个例子中，用于区分这个数据库连接的名字是<code class="prettyprint">QString("conn%1").arg(dbName)</code>，而不是 “QSQLITE”。这个参数是可选的，如果不指定，系统会给出一个默认的名字<code class="prettyprint">QSqlDatabase::defaultConnection</code>，此时，Qt 会创建一个默认的连接。如果你给出的名字与已存在的名字相同，新的连接会替换掉已有的连接。通过这种设计，我们可以为一个数据库建立多个连接。</p><p>我们这里使用的是 sqlite 数据库，只需要指定数据库名字即可。如果是数据库服务器，比如 MySQL，我们还需要指定主机名、端口号、用户名和密码，这些语句使用注释进行了简单的说明。</p><p>接下来我们调用了<code class="prettyprint">QSqlDatabase::open()</code>函数，打开这个数据库连接。通过检查<code class="prettyprint">open()</code>函数的返回值，我们可以判断数据库是不是正确打开。</p><p>QtSql 模块中的类大多具有<code class="prettyprint">lastError()</code>函数，用于检查最新出现的错误。如果你发现数据库操作有任何问题，应该使用这个函数进行错误的检查。这一点我们也在上面的代码中进行了体现。当然，这只是最简单的实现，一般来说，更好的设计是，不要在数据库操作中混杂界面代码（并且将这个<code class="prettyprint">connect()</code>函数放在一个专门的数据库操作类中）。</p><p>接下来我们可以在<code class="prettyprint">main()</code>函数中使用这个<code class="prettyprint">connect()</code>函数：</p><p>C/C++</p><p><em class="mivhak-icon copy-icon"></em></p><p><em class="mivhak-icon expand-icon"></em></p><p><em class="mivhak-icon wrap-icon"></em></p><p><em class="mivhak-icon info-icon"></em></p><pre class="prettyprint lang-c_cpp ace_editor ace-xcode" style="font-size:14px;height:306px;">int&nbsp;main(int&nbsp;argc,&nbsp;char&nbsp;*argv[])
{
&nbsp;&nbsp;&nbsp;&nbsp;QApplication&nbsp;a(argc,&nbsp;argv);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(connect("demo.db"))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QSqlQuery&nbsp;query;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!query.exec("CREATE&nbsp;TABLE&nbsp;student&nbsp;("
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"id&nbsp;INTEGER&nbsp;PRIMARY&nbsp;KEY&nbsp;AUTOINCREMENT,"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"name&nbsp;VARCHAR,"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"age&nbsp;INT)"))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QMessageBox::critical(0,&nbsp;QObject::tr("Database&nbsp;Error"),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;query.lastError().text());
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;a.exec();
}</pre><p><code class="prettyprint">main()</code>函数中，我们调用这个<code class="prettyprint">connect()</code>函数打开数据库。如果打开成功，我们通过一个<code class="prettyprint">QSqlQuery</code>实例执行了 SQL 语句。同样，我们使用其<code class="prettyprint">lastError()</code>函数检查了执行结果是否正确。</p><p>注意这里的<code class="prettyprint">QSqlQuery</code>实例的创建。我们并没有指定是为哪一个数据库连接创建查询对象，此时，系统会使用默认的连接，也就是使用没有第二个参数的<code class="prettyprint">addDatabase()</code>函数创建的那个连接（其实就是名字为<code class="prettyprint">QSqlDatabase::defaultConnection</code>的默认连接）。如果没有这么一个连接，系统就会报错。也就是说，如果没有默认连接，我们在创建<code class="prettyprint">QSqlQuery</code>对象时必须指明是哪一个<code class="prettyprint">QSqlDatabase</code>对象，也就是<code class="prettyprint">addDatabase()</code>的返回值。</p><p>我们还可以通过使用<code class="prettyprint">QSqlQuery::isActive()</code>函数检查语句执行正确与否。如果<code class="prettyprint">QSqlQuery</code>对象是活动的，该函数返回 true。所谓“活动”，就是指该对象成功执行了<code class="prettyprint">exec()</code>函数，但是还没有完成。如果需要设置为不活动的，可以使用<code class="prettyprint">finish()</code>或者<code class="prettyprint">clear()</code>函数，或者直接释放掉这个<code class="prettyprint">QSqlQuery</code>对象。这里需要注意的是，如果存在一个活动的 SELECT 语句，某些数据库系统不能成功完成<code class="prettyprint">connect()</code>或者<code class="prettyprint">rollback()</code>函数的调用。此时，我们必须首先将活动的 SELECT 语句设置成不活动的。</p><p>创建过数据库表&nbsp;student 之后，我们开始插入数据，然后将其独取出来：</p><p>C/C++</p><p><em class="mivhak-icon copy-icon"></em></p><p><em class="mivhak-icon expand-icon"></em></p><p><em class="mivhak-icon wrap-icon"></em></p><p><em class="mivhak-icon info-icon"></em></p><pre class="prettyprint lang-c_cpp ace_editor ace-xcode" style="font-size:14px;height:391px;">if&nbsp;(connect("demo.db"))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;QSqlQuery&nbsp;query;
&nbsp;&nbsp;&nbsp;&nbsp;query.prepare("INSERT&nbsp;INTO&nbsp;student&nbsp;(name,&nbsp;age)&nbsp;VALUES&nbsp;(?,&nbsp;?)");
&nbsp;&nbsp;&nbsp;&nbsp;QVariantList&nbsp;names;
&nbsp;&nbsp;&nbsp;&nbsp;names&nbsp;&lt;&lt;&nbsp;"Tom"&nbsp;&lt;&lt;&nbsp;"Jack"&nbsp;&lt;&lt;&nbsp;"Jane"&nbsp;&lt;&lt;&nbsp;"Jerry";
&nbsp;&nbsp;&nbsp;&nbsp;query.addBindValue(names);
&nbsp;&nbsp;&nbsp;&nbsp;QVariantList&nbsp;ages;
&nbsp;&nbsp;&nbsp;&nbsp;ages&nbsp;&lt;&lt;&nbsp;20&nbsp;&lt;&lt;&nbsp;23&nbsp;&lt;&lt;&nbsp;22&nbsp;&lt;&lt;&nbsp;25;
&nbsp;&nbsp;&nbsp;&nbsp;query.addBindValue(ages);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!query.execBatch())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QMessageBox::critical(0,&nbsp;QObject::tr("Database&nbsp;Error"),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;query.lastError().text());
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;query.finish();
&nbsp;&nbsp;&nbsp;&nbsp;query.exec("SELECT&nbsp;name,&nbsp;age&nbsp;FROM&nbsp;student");
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(query.next())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QString&nbsp;name&nbsp;=&nbsp;query.value(0).toString();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;age&nbsp;=&nbsp;query.value(1).toInt();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qDebug()&nbsp;&lt;&lt;&nbsp;name&nbsp;&lt;&lt;&nbsp;":&nbsp;"&nbsp;&lt;&lt;&nbsp;age;
&nbsp;&nbsp;&nbsp;&nbsp;}
}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1;
}</pre><p>依旧连接到我们创建的 demo.db 数据库。我们需要插入多条数据，此时可以使用<code class="prettyprint">QSqlQuery::exec()</code>函数一条一条插入数据，但是这里我们选择了另外一种方法：批量执行。首先，我们使用<code class="prettyprint">QSqlQuery::prepare()</code>函数对这条 SQL 语句进行预处理，问号 ? 相当于占位符，预示着以后我们可以使用实际数据替换这些位置。简单说明一下，预处理是数据库提供的一种特性，它会将 SQL 语句进行编译，性能和安全性都要优于普通的 SQL 处理。在上面的代码中，我们使用一个字符串列表 names 替换掉第一个问号的位置，一个整型列表 ages 替换掉第二个问号的位置，利用<code class="prettyprint">QSqlQuery::addBindValue()</code>我们将实际数据绑定到这个预处理的 SQL 语句上。需要注意的是，names 和 ages 这两个列表里面的数据需要一一对应。然后我们调用<code class="prettyprint">QSqlQuery::execBatch()</code>批量执行 SQL，之后结束该对象。这样，插入操作便完成了。</p><p>另外说明一点，我们这里使用了 ODBC 风格的 ? 占位符，同样，我们也可以使用 Oracle 风格的占位符：</p><p>C/C++</p><p><em class="mivhak-icon copy-icon"></em></p><p><em class="mivhak-icon expand-icon"></em></p><p><em class="mivhak-icon wrap-icon"></em></p><p><em class="mivhak-icon info-icon"></em></p><pre class="prettyprint lang-c_cpp ace_editor ace-xcode" style="font-size:14px;height:17px;">query.prepare("INSERT&nbsp;INTO&nbsp;student&nbsp;(name,&nbsp;age)&nbsp;VALUES&nbsp;(:name,&nbsp;:age)");</pre><p>此时，我们就需要使用</p><p>C/C++</p><p><em class="mivhak-icon copy-icon"></em></p><p><em class="mivhak-icon expand-icon"></em></p><p><em class="mivhak-icon wrap-icon"></em></p><p><em class="mivhak-icon info-icon"></em></p><pre class="prettyprint lang-c_cpp ace_editor ace-xcode" style="font-size:14px;height:34px;">query.bindValue(":name",&nbsp;names);
query.bindValue(":age",&nbsp;ages);</pre><p>进行绑定。Oracle 风格的绑定最大的好处是，绑定的名字和值很清晰，与顺序无关。但是这里需要注意，<code class="prettyprint">bindValue()</code>函数只能绑定一个位置。比如</p><p>C/C++</p><p><em class="mivhak-icon copy-icon"></em></p><p><em class="mivhak-icon expand-icon"></em></p><p><em class="mivhak-icon wrap-icon"></em></p><p><em class="mivhak-icon info-icon"></em></p><pre class="prettyprint lang-c_cpp ace_editor ace-xcode" style="font-size:14px;height:51px;">query.prepare("INSERT&nbsp;INTO&nbsp;test&nbsp;(name1,&nbsp;name2)&nbsp;VALUES&nbsp;(:name,&nbsp;:name)");
//&nbsp;...
query.bindValue(":name",&nbsp;name);</pre><p>只能绑定第一个 :name 占位符，不能绑定到第二个。</p><p>接下来我们依旧使用同一个查询对象执行一个 SELECT 语句。如果存在查询结果，<code class="prettyprint">QSqlQuery::next()</code>会返回 true，直到到达结果最末，返回 false，说明遍历结束。我们利用这一点，使用 while 循环即可遍历查询结果。使用<code class="prettyprint">QSqlQuery::value()</code>函数即可按照 SELECT 语句的字段顺序获取到对应的数据库存储的数据。</p><p>对于数据库事务的操作，我们可以使用&nbsp;<code class="prettyprint">QSqlDatabase::transaction()</code>&nbsp;开启事务，<code class="prettyprint">QSqlDatabase::commit()</code>&nbsp;或者<code class="prettyprint">QSqlDatabase::rollback()</code>&nbsp;结束事务。使用<code class="prettyprint">QSqlDatabase::database()</code>函数则可以根据名字获取所需要的数据库连接。</p><h1>MFC中的sqlite操作</h1><p><br><a rel="nofollow" href="https://github.com/Hygens/UsersRegistrationSPA">	GitHub - Hygens/UsersRegistrationSPA: .NET Core Web + Web API + SQLite3 + AngularJS(1.7.5) + Webpack + Automations</a><br><a rel="nofollow" href="https://www.cnblogs.com/fudong071234/p/6424856.html">	VC++、MFC Sqlite3数据库的使用 - 付栋 - 博客园</a><br><a rel="nofollow" href="https://blog.csdn.net/akof1314/article/details/5937103">	VC连接SQLite3的方法(MFC封装类) - 无幻 - CSDN博客</a><br><a rel="nofollow" href="https://social.msdn.microsoft.com/Forums/vstudio/en-US/42f9b356-24b1-4f38-8f78-228559c545d2/how-to-use-sqlite-library-in-mfc-aplication?forum=vcgeneral">	How to use sqlite library in mfc aplication?</a><br><a rel="nofollow" href="https://www.codeproject.com/Articles/10060/SQLite3-MFC-Wrapper">	SQLite3 MFC Wrapper - CodeProject</a><br><a rel="nofollow" href="https://github.com/Jia-Hong-Peng/SQLite-with-MFC-in-Chinese">	SQLite-with-MFC-in-Chinese/MFCwithSQLiteSample at master · Jia-Hong-Peng/SQLite-with-MFC-in-Chinese</a><br><a rel="nofollow" href="https://github.com/SRombauts/SQLiteCpp">	SRombauts/SQLiteCpp: SQLiteC++ (SQLiteCpp) is a smart and easy to use C++ SQLite3 wrapper.</a><br><a rel="nofollow" href="https://gist.github.com/2424514">	A small example program using SQLite with C++</a><br><a rel="nofollow" href="https://gist.github.com/enile8/2424514">	A small example program using SQLite with C++</a><br><a rel="nofollow" href="https://github.com/jhpeng/sqlite">	Jia-Hong-Peng/sqlite: sqlite</a><br><a rel="nofollow" href="https://github.com/Jia-Hong-Peng/sqlite">	Jia-Hong-Peng/sqlite: sqlite</a><br><a rel="nofollow" href="https://github.com/Jia-Hong-Peng/sqlite/tree/master/sqlite">	sqlite/sqlite at master · Jia-Hong-Peng/sqlite</a><br><a rel="nofollow" href="https://github.com/Jia-Hong-Peng/SQLite-with-MFC-in-Chinese/tree/master/MFCwithSQLiteSample">SQLite-with-MFC-in-Chinese/MFCwithSQLiteSample at master · Jia-Hong-Peng/SQLite-with-MFC-in-Chinese</a><br></p>
    </div>
    
    
    <p class="pc_current ask-tip">登录后可下载附件，请<a href="https://auth.huaweicloud.com/authui/login?service=https://bbs.huaweicloud.com/blogs/101725#attachment&amp;locale=zh-cn">登录</a>或者<a href="https://reg.huaweicloud.com/registerui/public/custom/register.html?locale=zh-cn&amp;service=https://bbs.huaweicloud.com#/register">注册</a></p>

    <!-- 版权声明 start -->
    
   
    
    <!-- 版权声明 end -->

    <div class="blog-menu-footer m-blog-menu-footer-bottom">
        
        <a class="common-blog-menu-btn title_banner_7" target="_self" rel="noopener noreferrer" mate_data_ts="bbs_blogdetail_blogTag.click.Qt_Blog" title="Qt" href="https://developer.huaweicloud.com/tags/200249/blog_1">Qt</a>
        
        <a class="common-blog-menu-btn title_banner_7" target="_self" rel="noopener noreferrer" mate_data_ts="bbs_blogdetail_blogTag.click.C++_Blog" title="C++" href="https://developer.huaweicloud.com/tags/200434/blog_1">C++</a>
        
        <a class="common-blog-menu-btn title_banner_7" target="_self" rel="noopener noreferrer" mate_data_ts="bbs_blogdetail_blogTag.click.数据库_Blog" title="数据库" href="https://developer.huaweicloud.com/tags/200742/blog_1">数据库</a>
        
        <a class="common-blog-menu-btn title_banner_7" target="_self" rel="noopener noreferrer" mate_data_ts="bbs_blogdetail_blogTag.click.SQLite_Blog" title="SQLite" href="https://developer.huaweicloud.com/tags/200759/blog_1">SQLite</a>
        
    </div>
</div></div>